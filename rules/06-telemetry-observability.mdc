---
description: Closed-Loop Telemetry — măsoară TTI, cost/run, score, policy_hits.
globs:
  - "lib/telemetry/**"
alwaysApply: false
---

# 06-telemetry-observability.mdc — Telemetry & Observability

## Ce măsori la fiecare run

### Identitate & context
- run_id (uuid), module_id (M01–M50), module_version (semver)
- org_id, project_id, user_id  
- parameter_set_7d complet
- industry_pack activ (fintech, ecommerce, education)

### Timeline & TTA (Time-To-Artifact)
```typescript
interface Timeline {
  t_request: string;           // server receive
  t_plan_start: string;        // → t_plan_end  
  t_generate_start: string;    // → t_generate_end
  t_evaluate_start: string;    // → t_evaluate_end
  t_format_start: string;      // → t_format_end
  t_export_start: string;      // → t_export_end
}

interface Latency {
  plan_ms: number;
  generate_ms: number; 
  evaluate_ms: number;
  format_ms: number;
  export_ms: number;
  total_ms: number;
  tta: number;                 // time to first artifact
}
```

### Model & cost
- model: "gpt-4o", temperature, seed, top_p
- prompt_tokens, completion_tokens, total_tokens
- cache_hits (boolean), retries (number)
- est_cost_usd (pricing map × tokens)

### Calitate (Test Engine)
- scores: {clarity, execution, ambiguity, business_fit, composite} (0–100)
- verdict: "pass" | "partial_pass" | "fail"
- thresholds & weights folosite
- evaluator_feedback (rezumat 1–3 linii)

### Policy & compliance  
- policy_hits[]: ["GDPR", "IP", "SEC/FCA"]
- redactions: număr câmpuri anonimizate
- safety_blocked: boolean (conținut blocat)

### Export & rezultate
- artifacts[]: ["txt","md","json","pdf"] generate
- export_ok: boolean
- checksum_sha256 per fișier
- bundle_id (dacă Enterprise)

## KPI derivate (pe fereastră de timp)

### Performance metrics
- TTA p50/p90/p95 (text vs bundle)
- Rată eșec = #runs_fail / #runs_total  
- Tokeni/artefact (medie & p95)
- Cost/artefact (USD)

### Quality metrics
- Export success rate = #export_ok / #runs_total
- Quality pass rate = #verdict=pass / #runs_total
- Policy hit rate = #policy_hits>0 / #runs_total

### Segmentare
- Pe domain 7D, module, industry_pack
- Pe plan (Free/Creator/Pro/Enterprise)
- Pe org și user

## SLO/alertare

### Praguri critice
- TTA text: ≤ 60s (p95)
- TTA bundle: ≤ 5min (p95)  
- Fail rate 7d: < 2% (hard), < 5% (warning)
- Ambiguity p90: ≤ 20
- Composite score: medie ≥ 80
- Export success: ≥ 98%

### Alerting
- Slack/Email cu top module/domeniu care încalcă SLO-uri
- Cost alerts la threshold-uri (10€, 50€, 100€/lună)
- Performance regression detection
- Policy violation spikes

## Payload JSON standard
```json
{
  "run_id": "uuid",
  "module_id": "M14", 
  "timeline": {...},
  "latency_ms": {...},
  "model": {"name":"gpt-4o","temperature":0.4},
  "tokens": {...},
  "cost": {"est_usd": 0.32},
  "scores": {...},
  "policy": {"hits": ["gdpr"], "redactions": 1},
  "export": {...},
  "status": "ok"
}
```

## Storage & querying
- Persistă în runs.telemetry (JSONB)
- Index pe org_id, module_id, created_at
- Views pentru agregări frecvente
- Retention: Free 7d, Pro 90d, Enterprise unlimited