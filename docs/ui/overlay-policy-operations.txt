UI OVERLAY POLICY — ONE-PAGER (OPERATIONS)

SCOP
— Ții overlay-ul sub control unic (SSOT → ruleset.yml).
— Menții performanța (≤50ms apply P95), siguranța (cleanup corect), accesibilitatea (respectă reduced-motion).

SSOT (singurul adevăr)
— cursor/ruleset.yml → policies.ui_overlays:
  • target_selector, route_class_map, state_class_map (quote_active/quote_focus), css_vars, diagnostics, performance.
— Nu modifici clase/variabile în cod; editezi doar ruleset.yml.

FLUX ZILNIC (Add / Change / Remove)

Adaugi overlay pentru o rută nouă:
1. Adaugi în route_class_map: "/nou": "route-nou".
2. (Opțional) Adaugi css_vars pentru gradient.
3. Rulezi: pnpm build && pnpm test:e2e:overlays.

Schimbi comportament focus citat:
• În componentă: import { useQuoteFocus } → set(true/false) la hover/click.
• Sau folosești <QuoteBlock> care gestionează automat.

Scoți o rută: 
• O elimini din SSOT; controller face cleanup.

PERFORMANȚĂ & OBSERVABILITATE
— SLO: overlay.apply.ms ≤ 50ms (P95), overlay.focus.ms ≤ 20ms (P95).
— Telemetrie minimă: overlay.apply.ms, overlay.cleanup.ok, overlay.focus.toggles, route.
— Dev diag (local): NEXT_PUBLIC_OVERLAY_DIAGNOSTICS=1; Prod = 0.

RELEASE (prod)
— Branch: feat/ui-overlay-<scop>.
— Bump: X-PF-Ruleset-Version în ruleset.yml + header.
— CI trebuie să treacă: test:e2e:overlays, english-only, lint, a11y.
— Lighthouse ≥ 90; fără console.log în producție.

PLAYBOOK INCIDENTE
Simptome: flicker, latență >50ms, rămâne clasă veche, consum CPU.

Acțiune rapidă: 
• setezi policies.ui_overlays.enabled=false în ruleset.yml → rebuild.

Canary: 
• activezi diag doar pe preprod; compari apply.ms.

Rollback: 
• folosești varianta precedentă de ruleset.yml; 
• dacă e CPU-heavy, setezi css_vars → fără transition.

GUARDRAILS
— Lint: interzici querySelector/DOM pe #bg-overlay în afara OverlayController/quote-focus.
— CODEOWNERS: components/OverlayController.tsx, lib/quote-focus.tsx, cursor/ruleset.yml → review obligatoriu.

TEST RAPID (local)
— / → #bg-overlay are .route-marketing în ≤50ms.
— /generator → hover pe <blockquote> crește overlay opacity, scade .matrix-tokens (≈0.28).
— /dashboard → clasa rutei se schimbă, fără "scurgeri" de clase.
— Reduced-motion: tranzițiile se dezactivează.

CRITERII DE ACCEPTANȚĂ (must)
— Single route class; cleanup on unmount = true.
— SLO respectat (P95).
— No console log în producție.
— A11y AA menținut.

COMENZI UTILE
# Test local complet
pnpm dev
# Navighează manual prin rute și testează hover pe citate

# Build și test
pnpm build
pnpm test:e2e:overlays

# Diagnostics în dev
NEXT_PUBLIC_OVERLAY_DIAGNOSTICS=1 pnpm dev

# Verificare lint
pnpm lint

# Verificare performanță
pnpm lighthouse

STRUCTURA FIȘIERE
cursor/ruleset.yml                    # SSOT configuration
components/OverlayController.tsx      # Single controller
lib/quote-focus.tsx                  # Global state management
components/ui/QuoteBlock.tsx         # DX component
app/globals.css                      # CSS variables & animations
tests/e2e/ui-overlay-policy.spec.ts  # E2E tests
docs/ui/overlay-policy-operations.txt # Acest document

DEBUGGING COMMON ISSUES
1. Overlay nu se aplică:
   • Verifică că OverlayController e în ClientRootLayout
   • Verifică că #bg-overlay există în DOM
   • Verifică route_class_map în ruleset.yml

2. Performanță slabă:
   • Activează NEXT_PUBLIC_OVERLAY_DIAGNOSTICS=1
   • Verifică console pentru warning-uri de performanță
   • Verifică că will-change e setat pe overlay

3. Quote focus nu funcționează:
   • Verifică că QuoteFocusProvider înfășoară aplicația
   • Verifică că .matrix-tokens există în DOM
   • Verifică CSS variables --tokens-opacity

4. Clase rămân în DOM:
   • Verifică cleanup în useEffect
   • Verifică că nu ai manipulări directe de DOM în alte componente
   • Rulează test E2E pentru cleanup verification

MONITORING & ALERTING
— overlay.apply.ms > 50ms → WARNING
— overlay.focus.ms > 20ms → WARNING  
— overlay.cleanup.failed → ERROR
— console.log în producție → ERROR
— route class duplicates → ERROR

RELEASE CHECKLIST
□ cursor/ruleset.yml actualizat
□ X-PF-Ruleset-Version incrementat
□ Tests E2E trec
□ Lighthouse ≥ 90
□ No console.log în producție
□ A11y AA compliance verificat
□ Performance SLO respectat
□ Documentation actualizată
