




LicenÈ›e & Entitlements pentru PROMPTFORGEâ„¢, astfel Ã®ncÃ¢t fiecare capabilitate (feature flag) sÄƒ fie mapatÄƒ clar pe plan (SKU) È™i, unde e cazul, pe pachete de industrie. Totul e conform specificaÈ›iilor oficiale din standard È™i schema Supabase/Stripe.

ğŸ—‚ Entitlements Canonice (feature flags)

canUseAllModules â€“ acces M01â€“M50

canExportMD â€“ export .md

canExportPDF â€“ export .pdf

canExportJSON â€“ export .json

canUseGptTestReal â€“ rulare Test Engine pe GPT live

hasCloudHistory â€“ istoric prompturi Ã®n Supabase (nelimitat)

hasEvaluatorAI â€“ scoruri + feedback din Evaluator AI

hasAPI â€“ acces endpoint public /api/run/{moduleId}

hasWhiteLabel â€“ branding customizat + self-host license

canExportBundleZip â€“ bundle complet (.txt/.md/.json/.pdf + checksum)

hasSeatsGT1 â€“ licenÈ›Äƒ multi-seat (Enterprise)

ğŸ“¦ Mapping pe Planuri (SKU generice)
Plan	Entitlements implicite
Free	canUseAllModules=false, canExportMD=false, acces doar subset (M01, M10, M18), fÄƒrÄƒ GPT live, fÄƒrÄƒ export avansat
Creator	canUseAllModules=true, canExportMD=true, dar fÄƒrÄƒ PDF/JSON, fÄƒrÄƒ GPT live, fÄƒrÄƒ cloud history
Pro	Include Creator + canExportPDF, canExportJSON, canUseGptTestReal, hasCloudHistory, hasEvaluatorAI
Enterprise	Include Pro + hasAPI, hasWhiteLabel, canExportBundleZip, hasSeatsGT1
ğŸŒ Mapping pe Industry Packs

Industry Packs extind planul de bazÄƒ (Creator/Pro/Enterprise) cu preseturi de domeniu + subset de module + KPIs.

Exemple

FinTech Pack (1.990â‚¬/an)

Modules: M07, M13, M31, M33, M44, M50

Domain preset: jargon (KYC, AMLâ€¦), KPIs (fraud_rate, KYC_timeâ€¦), compliance SEC/FCA

Export bundle spec+json obligatoriu (audit-like)

Gating: disponibil doar Pro/Enterprise (nu Free)

E-Commerce Pack (1.490â‚¬/an)

Modules: M03, M09, M13, M14, M22, M32

Domain preset: KPIs (CR, AOV, LTVâ€¦), guardrails (claritate preÈ›/retur)

Default output: playbook+checklist (implementation focus)

Education Pack (1.490â‚¬/an)

Modules: M21, M23, M25, M31, M38, M47

Domain preset: KPIs (completion, engagement, retention), compliance (privacy/plagiat)

Default output: playbook+spec

âš™ï¸ Flux de aplicare Ã®n sistem

Stripe â†’ Supabase: webhook actualizeazÄƒ subscriptions.plan_code È™i genereazÄƒ entitlements efective.

Industry Pack activat: se insereazÄƒ Ã®n org_industry_packs, aplicÄƒ domain_config preset (jargon, KPIs, compliance, style_bias).

API & UI gating: la fiecare acÈ›iune (export/test/API) se verificÄƒ entitlements â†’ dacÄƒ flag=FALSE â†’ paywall/upsell.

Audit: entitlements persistate cu source (plan|addon|pack|license) â†’ trasabilitate Ã®n DB.







Ãn PROMPTFORGEâ„¢ v3, Entitlements Canonice funcÈ›ioneazÄƒ ca feature flags binare, care controleazÄƒ capabilitÄƒÈ›ile UI, API È™i export. Le detaliez pe fiecare, cu rol, logicÄƒ de gating È™i implicaÈ›ii practice:

ğŸ—‚ Entitlements Canonice (feature flags)
1. canUseAllModules

Rol: permite accesul la Ã®ntregul set M01â€“M50.

False â†’ acces doar la subset free/demo (ex: M01 Persona, M07 Risk Reversal, M14 Landing Page).

True â†’ vizibilitate È™i rulare completÄƒ Ã®n editor + API.

ImplicaÈ›ie: primul flag care separÄƒ Free de Creator/Pro/Enterprise.

2. canExportMD

Rol: permite exportul .md (Markdown), folosit ca format standard lizibil pentru documentaÈ›ie È™i playbookuri.

False â†’ UI ascunde buton â€Export .mdâ€ â†’ se poate doar copy-paste.

True â†’ /export/md devine disponibil.

Use case: Creator+ (minim).

3. canExportPDF

Rol: permite export .pdf (raport comercial brand-uit).

False â†’ PDF generat doar ca preview intern (fÄƒrÄƒ download).

True â†’ download PDF activ.

Use case: Pro+.

ImplicaÈ›ie: serveÈ™te ca â€premium unlockâ€ pentru livrabile comerciale (consulting, training, enterprise reports).

4. canExportJSON

Rol: permite export .json (artefacte structurale, config, schema).

False â†’ UI/API blocheazÄƒ acces JSON.

True â†’ endpoint /export/json deschis.

Use case: Pro+ (tehnic/dev).

ImplicaÈ›ie: necesar pentru integrare cu alte sisteme (automation, CI/CD).

5. canUseGptTestReal

Rol: permite rularea Test Engine pe GPT live (scoruri pe claritate/execution/ambiguity/business_fit).

False â†’ doar test offline (simulat).

True â†’ execuÈ›ie realÄƒ cu cost API, telemetry log + verdict.

Use case: Pro+ (tool de QA È™i validare).

ImplicaÈ›ie: consum tokens â†’ necesitÄƒ plan plÄƒtit.

6. hasCloudHistory

Rol: persistÄƒ istoricul prompturilor È™i bundle-urilor Ã®n Supabase (nelimitat).

False â†’ doar localStorage/cache; È™tergere dupÄƒ 7 zile.

True â†’ DB cloud + UI timeline + cÄƒutare full-text.

Use case: Pro/Enterprise.

ImplicaÈ›ie: retention diferenÈ›iat (Free: 7 zile; Pro: 90 zile; Enterprise: nelimitat).

7. hasEvaluatorAI

Rol: acces la Evaluator AI (scoring + feedback text explicativ).

False â†’ doar scor numeric simplu.

True â†’ scor + feedback narativ + recomandÄƒri automate (tighten, optimize, crisis mode).

Use case: Pro+.

ImplicaÈ›ie: layer cognitiv suplimentar â†’ permite auto-repair & coaching AI.

8. hasAPI

Rol: acces endpoint public /api/run/{moduleId} cu key/token.

False â†’ doar UI.

True â†’ integrabil Ã®n pipelines externe.

Use case: Enterprise.

ImplicaÈ›ie: gating pe planurile care includ integrÄƒri automate (Stripe seat billing + audit).

9. hasWhiteLabel

Rol: branding customizat + self-host license.

False â†’ branding PROMPTFORGEâ„¢ by default.

True â†’ logo, culori, domeniu propriu, licenÈ›Äƒ whitelabel.

Use case: Enterprise.

ImplicaÈ›ie: asociat direct cu contracte B2B high-ticket.

10. canExportBundleZip

Rol: export complet .zip cu toate artefactele: .txt, .md, .json, .pdf, telemetry.json, checksum.txt, manifest.json.

False â†’ doar export individual per format.

True â†’ â€Download Bundleâ€ â†’ pachet validat + semnat.

Use case: Enterprise.

ImplicaÈ›ie: standard legal (audit, consultanÈ›Äƒ, QA).

11. hasSeatsGT1

Rol: licenÈ›Äƒ multi-seat (mai mulÈ›i useri/org).

False â†’ doar single-user.

True â†’ gestionare seat-uri, invitaÈ›ii, roluri.

Use case: Enterprise.

ImplicaÈ›ie: Stripe seat billing, integrat cu Supabase RLS (org_id).

ğŸ”‘ ObservaÈ›ii

Toate aceste flaguri sunt bool per subscription/org.

Sunt mapate Ã®n tabelul entitlements (Supabase) È™i propagate Ã®n UI + API prin JWT claims.

DiferenÈ›iere: Planurile (Free/Creator/Pro/Enterprise) definesc combinaÈ›ia standard â†’ Packs & Addons adaugÄƒ flaguri suplimentare.

Compatibilitate Stripe: fiecare plan â†’ SKU cu set de entitlements default; packs â†’ org_industry_packs.






ConÈ›inut cheie (Ã®n folderul ZIP):

licensing/feature_flags.json â€” definiÈ›ii oficiale ale entitlements (11 flags).

licensing/plans.json â€” planurile Free / Creator / Pro / Enterprise cu toate flagurile, allowlist module, exporturi permise È™i retenÈ›ie.

licensing/plan_entitlements_matrix.csv â€” matrice vizualÄƒ TRUE/FALSE pe toate entitlements Ã— plan.

licensing/seed_plans_entitlements.sql â€” seed SQL (creeazÄƒ tabele entitlements, plans, plan_entitlements È™i insereazÄƒ datele).

licensing/stripe_products_seed.json â€” schelet produse & preÈ›uri Stripe (cu placeholder IDs).




ğŸ“¦ Rezumat mapping pe planuri (SKU generice)
Plan	canUseAllModules	canExportMD	canExportPDF	canExportJSON	canUseGptTestReal	hasCloudHistory	hasEvaluatorAI	hasAPI	hasWhiteLabel	canExportBundleZip	hasSeatsGT1	Module allowlist	Exports	RetenÈ›ie
Free	âŒ	âŒ	âŒ	âŒ	âŒ	âŒ	âŒ	âŒ	âŒ	âŒ	âŒ	M01,M10,M18	txt	7 zile
Creator	âœ…	âœ…	âŒ	âŒ	âŒ	âŒ	âŒ	âŒ	âŒ	âŒ	âŒ	ALL	txt, md	30 zile
Pro	âœ…	âœ…	âœ…	âœ…	âœ…	âœ…	âœ…	âŒ	âŒ	âŒ	âŒ	ALL	txt, md, json, pdf	90 zile
Enterprise	âœ…	âœ…	âœ…	âœ…	âœ…	âœ…	âœ…	âœ…	âœ…	âœ…	âœ…	ALL	txt, md, json, pdf, bundle	nelimitat

Note:

Free are subset de module: M01, M10, M18 (conform cerinÈ›ei tale).

Creator deblocheazÄƒ .md, dar nu are cloud history sau GPT live.

Pro adaugÄƒ Test Engine live, Evaluator AI, JSON/PDF È™i Cloud History.

Enterprise adaugÄƒ API, WhiteLabel, Bundle ZIP È™i multiâ€‘seat.





# Create Industry Pack JSON configs and a small README, then zip them for download.
import json, os, zipfile, textwrap, datetime, hashlib

base = "/mnt/data/industry_packs"
os.makedirs(base, exist_ok=True)

schema = {
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "IndustryPack",
  "type": "object",
  "required": ["slug","title","price_eur_per_year","min_plan","modules","domain_preset","export_requirements"],
  "properties": {
    "slug": {"type":"string"},
    "title": {"type":"string"},
    "price_eur_per_year": {"type":"integer"},
    "min_plan": {"type":"string", "enum":["creator","pro","enterprise"]},
    "modules": {"type":"array","items":{"type":"string","pattern":"^M\\d{2}$"}},
    "domain_preset": {
      "type":"object",
      "required":["jargon","kpis","compliance_notes","style_bias","default_output_format","risk_level"],
      "properties": {
        "jargon":{"type":"array","items":{"type":"string"}},
        "kpis":{"type":"array","items":{"type":"string"}},
        "compliance_notes":{"type":"string"},
        "style_bias":{"type":"string"},
        "default_output_format":{"type":"string"},
        "risk_level":{"type":"string", "enum":["low","medium","high"]}
      }
    },
    "defaults_7d": {
      "type":"object",
      "properties": {
        "scale":{"type":"string"},
        "urgency":{"type":"string"},
        "complexity":{"type":"string"},
        "resources":{"type":"string"},
        "application":{"type":"string"},
        "output":{"type":"array","items":{"type":"string"}}
      }
    },
    "export_requirements": {"type":"array","items":{"type":"string"}},
    "evaluator_lints": {"type":"array","items":{"type":"string"}},
    "guardrails": {"type":"array","items":{"type":"string"}},
    "ui": {"type":"object","properties":{
        "upsell_banner_copy":{"type":"string"},
        "paywall_feature":{"type":"string"}
    }},
    "stripe": {"type":"object","properties":{
        "floor_eur":{"type":"integer"},
        "product_id":{"type":"string"},
        "price_id_monthly":{"type":"string"},
        "price_id_annual":{"type":"string"}
    }},
    "supabase": {"type":"object","properties":{
        "gating_sql_note":{"type":"string"}
    }}
  }
}

packs = [
  {
    "slug":"fintech",
    "title":"FinTech Pack",
    "price_eur_per_year":1990,
    "min_plan":"pro",
    "modules":["M07","M13","M31","M33","M44","M50"],
    "domain_preset":{
      "jargon":["KYC","AML","regtech","sandboxing"],
      "kpis":["fraud_rate","KYC_time","approval_rate"],
      "compliance_notes":"SEC/FCA sensitive; claims must be verifiable; no forward-looking statements without sources",
      "style_bias":"analytical, layered, formal; audit-like phrasing",
      "default_output_format":"spec",
      "risk_level":"high"
    },
    "defaults_7d":{
      "scale":"enterprise",
      "urgency":"sprint",
      "complexity":"advanced",
      "resources":"full_stack_org",
      "application":"implementation",
      "output":["spec","json","playbook"]
    },
    "export_requirements":["spec","json"],
    "evaluator_lints":[
      "Flag unverifiable financial claims",
      "Ensure every risk/guarantee cites an authoritative source",
      "Require datestamps on regulatory references"
    ],
    "guardrails":[
      "No advice implying regulatory approval",
      "Surface data lineage (src_hash, author, date) in artifacts"
    ],
    "ui":{
      "upsell_banner_copy":"ActivÄƒ FinTech Mode: KYC/AML presets, audit-grade exports (.spec + .json).",
      "paywall_feature":"industryPack_fintech"
    },
    "stripe":{"floor_eur":1490,"product_id":"","price_id_monthly":"","price_id_annual":""},
    "supabase":{"gating_sql_note":"SELECT 1 FROM org_industry_packs WHERE org_id=$1 AND pack_slug='fintech';"}
  },
  {
    "slug":"ecommerce",
    "title":"E-Commerce Pack",
    "price_eur_per_year":1490,
    "min_plan":"pro",
    "modules":["M03","M09","M13","M14","M22","M32"],
    "domain_preset":{
      "jargon":["CR","AOV","LTV","CAC","RFM segmentation"],
      "kpis":["conversion_rate","average_order_value","lifetime_value","return_rate"],
      "compliance_notes":"Transparent pricing & returns; consumer protection",
      "style_bias":"operational, test-driven, crisp CTAs",
      "default_output_format":"playbook",
      "risk_level":"medium"
    },
    "defaults_7d":{
      "scale":"smb",
      "urgency":"sprint",
      "complexity":"standard",
      "resources":"lean_team",
      "application":"implementation",
      "output":["playbook","checklist","json"]
    },
    "export_requirements":["playbook","checklist"],
    "evaluator_lints":[
      "Check copy for clear price & returns policy",
      "Ensure KPI ownership and thresholds per experiment"
    ],
    "guardrails":["No dark patterns; explicit opt-in/out"],
    "ui":{
      "upsell_banner_copy":"PorneÈ™te Eâ€‘Commerce Mode: CR/AOV/LTV presets + playbook & checklist auto.",
      "paywall_feature":"industryPack_ecommerce"
    },
    "stripe":{"floor_eur":1490,"product_id":"","price_id_monthly":"","price_id_annual":""},
    "supabase":{"gating_sql_note":"SELECT 1 FROM org_industry_packs WHERE org_id=$1 AND pack_slug='ecommerce';"}
  },
  {
    "slug":"education",
    "title":"Education Pack",
    "price_eur_per_year":1490,
    "min_plan":"pro",
    "modules":["M21","M23","M25","M31","M38","M47"],
    "domain_preset":{
      "jargon":["LMS","cohort","asynchronous/synchronous","rubric-based grading"],
      "kpis":["completion_rate","engagement_rate","retention_rate"],
      "compliance_notes":"Privacy first; anti-plagiarism; academic integrity",
      "style_bias":"supportive, rubric-driven, transparent feedback",
      "default_output_format":"playbook",
      "risk_level":"medium"
    },
    "defaults_7d":{
      "scale":"startup",
      "urgency":"planned",
      "complexity":"advanced",
      "resources":"lean_team",
      "application":"training",
      "output":["playbook","spec","json"]
    },
    "export_requirements":["playbook","spec"],
    "evaluator_lints":[
      "Detect potential plagiarism indicators in examples",
      "Require anonymization on student data & PII hashing"
    ],
    "guardrails":["No storage of PII without consent; disclose model usage to learners"],
    "ui":{
      "upsell_banner_copy":"ActiveazÄƒ Education Mode: KPIâ€‘uri completion/engagement + playbook & spec.",
      "paywall_feature":"industryPack_education"
    },
    "stripe":{"floor_eur":1490,"product_id":"","price_id_monthly":"","price_id_annual":""},
    "supabase":{"gating_sql_note":"SELECT 1 FROM org_industry_packs WHERE org_id=$1 AND pack_slug='education';"}
  }
]

# write files
with open(os.path.join(base, "schema.industry-pack.json"), "w") as f:
    json.dump(schema, f, indent=2)

for pack in packs:
    with open(os.path.join(base, f"{pack['slug']}.json"), "w") as f:
        json.dump(pack, f, indent=2)

readme = f"""# Industry Packs (PROMPTFORGE v3)
Generated: {datetime.datetime.utcnow().isoformat()}Z

Files:
- `schema.industry-pack.json` â€” canonical schema
- `fintech.json` â€” FinTech Pack (Pro/Enterprise only; audit-grade exports .spec + .json)
- `ecommerce.json` â€” Eâ€‘Commerce Pack (Pro/Enterprise; playbook + checklist)
- `education.json` â€” Education Pack (Pro/Enterprise; playbook + spec)

Import into Supabase:
1) Create `industry_packs` rows from these JSONs (one row per pack).
2) Gate usage via `org_industry_packs` and plan entitlements.
3) Enforce price floor via Stripe config and webhook policy.
"""
with open(os.path.join(base, "README.md"), "w") as f:
    f.write(readme)






iatÄƒ mapping-ul complet pentru Industry Packs + fiÈ™ierele gata de folosit (JSON + schema + README).

ğŸ“¦ Spec canonic Industry Pack (contract)

CÃ¢mpuri: slug, title, price_eur_per_year, min_plan, modules[] (Mxx), domain_preset{jargon[],kpis[],compliance_notes,style_bias,default_output_format,risk_level}, defaults_7d{â€¦}, export_requirements[], evaluator_lints[], guardrails[], ui{upsell_banner_copy,paywall_feature}, stripe{floor_eur,â€¦}, supabase{gating_sql_note}.

Gating: pack-urile se ataÈ™eazÄƒ peste planurile Pro/Enterprise (nu Free). Enforcement se face la /api/run/{moduleId} prin entitlements + check pack (org_industry_packs).

Export: bundle MD/PDF/JSON + checksum; pack-ul poate impune formate minime (ex. .spec+.json pentru FinTech).

UI: upsell la schimbarea domain (banner/buton) + paywall pe acÈ›iuni (Test GPT real, export bundle, API).

Evaluator AI: scoruri (clarity/execution/ambiguity/alignment/business_fit) + lints specifice domeniului.

Modelare DB: tabele industry_packs, org_industry_packs; flags & gating Ã®n entitlements.

ğŸ¦ FinTech Pack â€” 1.990 â‚¬/an (Pro/Enterprise)

Modules: M07 (Risk & Trust), M13 (Pricing), M31 (Telemetry), M33 (Lead Scoring), M44 (Ethical Guardrails), M50 (CUSNIR.OS).

Domain preset:

jargon: KYC, AML, regtech, sandboxing;

KPIs: fraud_rate, KYC_time, approval_rate;

compliance: â€SEC/FCA sensitive; fÄƒrÄƒ claims neverificateâ€;

stil: formal, stratificat (â€audit-likeâ€).

Default 7D: scale=enterprise, urgency=sprint, complexity=advanced, resources=full_stack_org, application=implementation; output: spec/json/playbook.

Export (obligatoriu): .spec + .json (audit trail, datÄƒ/autor/sursÄƒ).

Evaluator lints: citeazÄƒ reglementÄƒri cu datÄƒ; marcheazÄƒ afirmaÈ›ii financiare neverificabile; cere provenance (src_hash).

ğŸ›’ Eâ€‘Commerce Pack â€” 1.490 â‚¬/an (Pro/Enterprise)

Modules: M03 (Campanii 7:1), M09 (Subscription Engine), M13 (Pricing), M14 (Contentâ†’Commerce), M22 (Lead Gen SOP), M32 (Cohort Experiments).

Domain preset:

KPIs: CR, AOV, LTV, return_rate;

guardrails: claritate preÈ›/retur;

stil: operaÈ›ional, testâ€‘driven.

Default output: playbook + checklist (focus implementare).

Evaluator lints: proprietari KPI/threshold-uri pe experimente; detecteazÄƒ darkâ€‘patterns.

ğŸ“ Education Pack â€” 1.490 â‚¬/an (Pro/Enterprise)

Modules: M21 (SOP AI Ã®n Moodle), M23 (Podcastâ†’Carte), M25 (Knowledge Security), M31 (Telemetry), M38 (Blueprint AntiÈ™coalÄƒ), M47 (Curriculum INTELIGENÈšIAâ„¢).

Domain preset:

KPIs: completion, engagement, retention;

compliance: privacy/plagiat;

stil: suportiv, rubric-driven.

Default output: playbook + spec.

Evaluator lints: semnale antiâ€‘plagiat; anonimizare PII; disclosure folosire model.

ğŸ—„ï¸ Supabase â€” seed & gating (DDL/SQL)
-- 1) Catalog packs
insert into industry_packs(slug,title,modules,domain_config,price_eur)
values
('fintech','FinTech Pack',  ARRAY['M07','M13','M31','M33','M44','M50'],
 '{"jargon":["KYC","AML","regtech","sandboxing"],
   "kpis":["fraud_rate","KYC_time","approval_rate"],
   "compliance_notes":"SEC/FCA sensitive; verifiable-only",
   "style_bias":"analytical, layered, formal",
   "default_output_format":"spec","risk_level":"high"}'::jsonb, 1990),
('ecommerce','Eâ€‘Commerce Pack',ARRAY['M03','M09','M13','M14','M22','M32'],
 '{"kpis":["CR","AOV","LTV","return_rate"],
   "compliance_notes":"Transparent pricing & returns",
   "style_bias":"operational, test-driven",
   "default_output_format":"playbook","risk_level":"medium"}'::jsonb, 1490),
('education','Education Pack',ARRAY['M21','M23','M25','M31','M38','M47'],
 '{"kpis":["completion","engagement","retention"],
   "compliance_notes":"privacy & anti-plagiarism",
   "style_bias":"supportive, rubric-driven",
   "default_output_format":"playbook","risk_level":"medium"}'::jsonb, 1490);

-- 2) Activare Ã®n org (dupÄƒ checkout Stripe)
insert into org_industry_packs(org_id, pack_slug) values (:org,'fintech');

-- 3) Gating la /api/run/{moduleId}
-- (pseudo) refuzÄƒ dacÄƒ plan < Pro sau pack absent cÃ¢nd domain='FinTech'
-- SELECT * FROM entitlements e WHERE org_id=:org AND flag='plan_code' IN ('pro','enterprise');
-- SELECT 1 FROM org_industry_packs WHERE org_id=:org AND pack_slug='fintech';


Schema/tabelele pentru packs + RLS apar Ã®n modelarea v3 (industry_packs/org_industry_packs).

ğŸ’³ Stripe â€” SKU & floor

PreÈ›uri: FinTech 1.990 â‚¬/an; Eâ€‘Commerce/Education 1.490 â‚¬/an. Floor minim Industry Pack â‰¥ 1.490 â‚¬ (validat Ã®n webhook).

Recomandare: floor_eur Ã®n config + verificare Ã®n stripe_events/webhook, cu respingere dacÄƒ < floor.

ğŸ” Enforcement (rulare / export / API)

/api/run/{moduleId}: verificÄƒ plan + entitlement + pack (dacÄƒ domain=pack). RÄƒspunsul include hash, timestamp, KPIs, cost; log obligatoriu.

Export Bundle: genereazÄƒ .txt .md .json .pdf telemetry.json checksum.txt (+ .zip Enterprise) È™i blocheazÄƒ formatele neincluse Ã®n entitlement; FinTech: forÈ›eazÄƒ .spec+.json.

Evaluator AI: ruleazÄƒ postâ€‘run cu rubricÄƒ 0â€“100Ã—5, memoreazÄƒ scor/feedback; butoane â€Tighten/Optimize for Enterprise/Crisisâ€.

ğŸ§© UI & upsell

Banner la schimbarea domain â‡’ sugereazÄƒ pack (ex. â€œActiveazÄƒ FinTech Mode: KYC/AML presets, auditâ€‘grade exportsâ€).

Paywall pe acÈ›iuni â€ahaâ€: Run GPT Test (real), Export .pdf/.json/.bundle, API.

ğŸ“ FiÈ™iere gata de import (JSON + schema)

Am generat pentru tine tot setul (schema + 3 packâ€‘uri) â€” le poÈ›i importa direct Ã®n repo/DB:

DescarcÄƒ pachetul Industry Packs (zip)
ConÈ›ine:

schema.industry-pack.json â€” schemÄƒ canonicÄƒ,

fintech.json, ecommerce.json, education.json â€” configâ€‘uri complete,

README.md â€” paÈ™i de import.





modelul de licenÈ›e & entitlements â†’ planuri â†’ industry packs direct pe blueprintul PROMPTFORGEâ„¢ v3 È™i schema Supabase/Stripe:

ğŸ—‚ Entitlements Canonice (feature flags)

canUseAllModules â€“ acces complet la M01â€“M50

canExportMD â€“ export .md

canExportPDF â€“ export .pdf

canExportJSON â€“ export .json

canUseGptTestReal â€“ acces Test Engine cu GPT live

hasCloudHistory â€“ istoric prompturi Ã®n Supabase

hasEvaluatorAI â€“ scoruri & feedback Evaluator AI

hasAPI â€“ acces public /api/run/{moduleId}

hasWhiteLabel â€“ branding custom + self-host license

canExportBundleZip â€“ bundle complet (.txt/.md/.json/.pdf + checksum)

hasSeatsGT1 â€“ licenÈ›Äƒ multi-seat (Enterprise)

Acestea sunt binare (true/false) È™i se ataÈ™eazÄƒ fie planului, fie add-on-ului.

ğŸ“¦ Mapping pe Planuri (SKU Generice)
Plan	Entitlements implicite
Free	canUseAllModules=false, canExportMD=false, acces doar subset (M01, M10, M18); fÄƒrÄƒ GPT live, fÄƒrÄƒ export avansat
Creator	canUseAllModules=true, canExportMD=true; dar fÄƒrÄƒ PDF/JSON, fÄƒrÄƒ GPT live, fÄƒrÄƒ cloud history
Pro	Include Creator + canExportPDF, canExportJSON, canUseGptTestReal, hasCloudHistory, hasEvaluatorAI
Enterprise	Include Pro + hasAPI, hasWhiteLabel, canExportBundleZip, hasSeatsGT1

â†’ Stocate Ã®n plans.flags ca snapshot JSONB.

ğŸŒ Mapping pe Industry Packs

Industry Packs = extensii verticale (doar Pro/Enterprise), cu subset module + preset de domeniu + KPI.

FinTech Pack (1.990 â‚¬/an)

Modules: M07, M13, M31, M33, M44, M50

Domain preset: jargon (KYC, AML, regtech), KPIs (fraud_rate, KYC_time), compliance SEC/FCA

Output obligatoriu: spec+json (audit-like)

Gating: doar Pro/Enterprise

E-Commerce Pack (1.490 â‚¬/an)

Modules: M03, M09, M13, M14, M22, M32

Domain preset: KPIs (CR, AOV, LTV), guardrails (claritate preÈ›/retur)

Output default: playbook+checklist (implementation focus)

Education Pack (1.490 â‚¬/an)

Modules: M21, M23, M25, M31, M38, M47

Domain preset: KPIs (completion, engagement, retention), compliance (privacy, plagiat)

Output default: playbook+spec

Industry Packs se activeazÄƒ prin org_industry_packs È™i aplicÄƒ auto-bias la generare.

ğŸ”‘ Integrare Stripe & Supabase

Stripe: SKU per plan (free, creator, pro, enterprise) + SKU per industry pack (fintech_core, ecommerce_core etc.).

Supabase:

plans = snapshot flags

subscriptions = Stripe sync (plan, seats, trial)

entitlements = derivate (plan|addon|license)

industry_packs + org_industry_packs = mapare industrie

Webhook Stripe â†’ upsert Ã®n entitlements È™i org_industry_packs





design complet, executabil pentru fluxul de aplicare LicenÈ›e & Entitlements Ã®n PROMPTFORGEâ„¢ v3 (Stripe â†’ Supabase â†’ API/UI), cu: modele de date, webhook logic (idempotent), funcÈ›ii SQL de calcul, gating server & UI, audit È™i scenarii edge. Totul este compatibil cu migraÈ›iile pe care le-ai primit deja.

âš™ï¸ ArhitecturÄƒ â€œendâ€‘toâ€‘endâ€

Surse de adevÄƒr

Stripe = billing & events (plan, addon, industry pack).

Supabase = state & gating (subscriptions, entitlements, packs, audit).

JWT = claimâ€‘uri runtime (org_id, plan_code).

RegulÄƒ de compoziÈ›ie

Entitlements efective = PLAN âŠ• ADDONS âŠ• PACKS âŠ• LICENSE
(âŠ• = OR logic pe fiecare flag)

Gating la execuÈ›ie

Orice acÈ›iune (run/test/export/API) verificÄƒ entitlements_effective (serverâ€‘side) â†’ altfel paywall/upsell (UI).

1) Modele de date (SQL â€“ extensii la schema existentÄƒ)
-- Planuri de preÈ› (snapshot de flags È™i meta)
create table if not exists plans (
  plan_code text primary key,                      -- "free"|"creator"|"pro"|"enterprise"
  title text not null,
  flags jsonb not null,                            -- {"canUseAllModules":true,...}
  module_allowlist text[] not null default '{}',   -- subset pt. planuri restrictive (ex. Free)
  retention_days int not null default 90,
  created_at timestamptz default now()
);

-- Subscriptions sincronizate din Stripe
create table if not exists subscriptions (
  id uuid primary key default uuid_generate_v4(),
  org_id uuid not null references orgs(id) on delete cascade,
  stripe_customer_id text not null,
  stripe_subscription_id text,
  plan_code text not null references plans(plan_code),
  status text not null,                            -- trialing|active|past_due|canceled|unpaid
  current_period_end timestamptz,
  seats int not null default 1,
  updated_at timestamptz default now(),
  unique(org_id, plan_code)
);

-- Entitlements atomice (proveniÈ›Äƒ: plan|addon|pack|license)
create type entitlement_source as enum ('plan','addon','pack','license');

create table if not exists entitlements (
  id bigserial primary key,
  org_id uuid not null references orgs(id) on delete cascade,
  flag text not null,
  value boolean not null default true,
  source entitlement_source not null,
  source_ref text,                                 -- ex: "pro" sau "fintech"
  created_at timestamptz default now(),
  unique (org_id, flag, source, source_ref)
);

-- Industry packs (catalog) + ataÈ™Äƒri la org
create table if not exists industry_packs (
  slug text primary key,                           -- "fintech"|"ecommerce"|"education"
  title text not null,
  min_plan text not null references plans(plan_code),
  price_eur int not null,
  modules text[] not null,
  domain_config jsonb not null,                    -- jargon, kpis, compliance, style, output
  created_at timestamptz default now()
);

create table if not exists org_industry_packs (
  org_id uuid not null references orgs(id) on delete cascade,
  pack_slug text not null references industry_packs(slug) on delete cascade,
  activated_at timestamptz default now(),
  unique(org_id, pack_slug)
);

-- Vedere: entitlements efective (OR pe toate sursele)
create or replace view entitlements_effective as
select
  e.org_id,
  e.flag,
  bool_or(e.value) as enabled
from entitlements e
group by e.org_id, e.flag;

-- Snapshot util pentru UI (plan curent)
create or replace view org_plan_snapshot as
select s.org_id, s.plan_code, p.flags, p.module_allowlist, p.retention_days, s.status
from subscriptions s
join plans p on p.plan_code = s.plan_code
where s.status in ('trialing','active','past_due');

2) FuncÈ›ii SQL pentru calcul & seed
-- 2.1 Upsert entitlements din plan (idempotent)
create or replace function pf_apply_plan_entitlements(p_org uuid, p_plan text)
returns void language sql as $$
  insert into entitlements(org_id, flag, value, source, source_ref)
  select p_org, key, (p.flags->>key)::boolean, 'plan', p_plan
  from plans p, jsonb_object_keys(p.flags) as key
  where p.plan_code = p_plan
  on conflict (org_id, flag, source, source_ref) do update
    set value = excluded.value, created_at = now();
$$;

-- 2.2 AplicÄƒ Industry Pack â†’ entitlements + preset domain_config
create or replace function pf_apply_pack(p_org uuid, p_pack_slug text)
returns void language plpgsql as $$
declare
  min_plan text;
begin
  -- ataÈ™eazÄƒ pack la org (idempotent)
  insert into org_industry_packs(org_id, pack_slug)
  values (p_org, p_pack_slug)
  on conflict do nothing;

  -- activeazÄƒ flag simbolic pentru gating UI/API (de ex. "industryPack_fintech")
  insert into entitlements(org_id, flag, value, source, source_ref)
  values (p_org, 'industryPack_'||p_pack_slug, true, 'pack', p_pack_slug)
  on conflict (org_id, flag, source, source_ref) do update set value=true, created_at=now();

  -- NOTE: domain_config se injecteazÄƒ la runtime (nu se copiazÄƒ Ã®n DB ca flags);
  -- dacÄƒ vrei snapshot, poÈ›i salva Ã®n tabel separat (org_domain_overrides).
end; $$;

-- 2.3 Revocare entitlements pentru plan (ex: downgrade/cancel)
create or replace function pf_revoke_plan_entitlements(p_org uuid, p_plan text)
returns void language sql as $$
  delete from entitlements
  where org_id = p_org and source='plan' and source_ref = p_plan;
$$;


Seed plans: populat anterior (Free, Creator, Pro, Enterprise) cu JSONB flags.

3) Stripe â†’ Supabase (webhook) â€” Edge Function

Evenimente utile

checkout.session.completed (start abonament sau pack)

customer.subscription.* (created/updated/deleted)

invoice.paid / invoice.payment_failed (pack renewals)

Principii

VerificÄƒ semnÄƒtura (Stripeâ€‘Signature header)

Idempotent: persistÄƒ event_id Ã®n stripe_events (unique), altfel ignorÄƒ

Mapare: SKU â†’ plan_code sau pack_slug

Upsert: Ã®n subscriptions + apel funcÈ›ii pf_apply_*

Skeleton (Deno/TypeScript)

// supabase/functions/stripe-webhook/index.ts
import { serve } from "https://deno.land/std/http/server.ts";
import Stripe from "https://esm.sh/stripe@13.6.0?target=deno";
import { createClient } from "https://esm.sh/@supabase/supabase-js";

const STRIPE_SECRET = Deno.env.get("STRIPE_SECRET")!;
const STRIPE_WEBHOOK_SECRET = Deno.env.get("STRIPE_WEBHOOK_SECRET")!;
const supabase = createClient(Deno.env.get("SUPABASE_URL")!, Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!);
const stripe = new Stripe(STRIPE_SECRET, { apiVersion: "2024-06-20" });

serve(async (req) => {
  const sig = req.headers.get("stripe-signature") ?? "";
  const body = await req.text();
  let event;

  try { event = stripe.webhooks.constructEvent(body, sig, STRIPE_WEBHOOK_SECRET); }
  catch (e) { return new Response("Invalid signature", { status: 400 }); }

  // idempotency: store event.id
  const { error: dupErr } = await supabase.from("stripe_events").insert({ id: event.id }).select().single().then(()=>({error:null})).catch(()=>({error:true}));
  if (dupErr) return new Response("OK (duplicate)", { status: 200 });

  // extract org by customer_id
  const customerId = (event.data.object as any).customer ?? (event.data.object as any).customer_id;
  const { data: orgRow } = await supabase.from("orgs").select("id").eq("stripe_customer_id", customerId).maybeSingle();
  if (!orgRow) return new Response("No org for customer", { status: 200 });

  const org_id = orgRow.id as string;

  // route events
  switch (event.type) {
    case "customer.subscription.created":
    case "customer.subscription.updated": {
      const sub = event.data.object as any;
      const plan_code = mapStripePriceToPlan(sub.items.data[0].price.id); // implement mapping
      const status = sub.status; const current_period_end = new Date(sub.current_period_end * 1000).toISOString();
      await supabase.from("subscriptions").upsert({
        org_id, stripe_customer_id: customerId, stripe_subscription_id: sub.id,
        plan_code, status, current_period_end, seats: sub.quantity ?? 1, updated_at: new Date().toISOString()
      }, { onConflict: "org_id,plan_code" });

      // apply plan entitlements
      await supabase.rpc("pf_apply_plan_entitlements", { p_org: org_id, p_plan: plan_code });
      break;
    }
    case "customer.subscription.deleted": {
      const sub = event.data.object as any;
      const plan_code = mapStripePriceToPlan(sub.items.data[0].price.id);
      await supabase.rpc("pf_revoke_plan_entitlements", { p_org: org_id, p_plan: plan_code });
      break;
    }
    case "checkout.session.completed": {
      const cs = event.data.object as any;
      const lineItems = await stripe.checkout.sessions.listLineItems(cs.id);
      for (const it of lineItems.data) {
        const sku = it.price?.id as string;
        const pack = mapStripePriceToPack(sku);      // implement mapping (e.g. price_ABC -> "fintech")
        const plan = mapStripePriceToPlan(sku);
        if (pack) await supabase.rpc("pf_apply_pack", { p_org: org_id, p_pack_slug: pack });
        if (plan) await supabase.rpc("pf_apply_plan_entitlements", { p_org: org_id, p_plan: plan });
      }
      break;
    }
  }

  return new Response("OK", { status: 200 });
});


Mapping: Èšine Ã®ntrâ€‘un tabel stripe_prices(plan_code, price_id) È™i stripe_prices_pack(pack_slug, price_id) ca sÄƒ eviÈ›i cod hardâ€‘codat.

4) Industry Pack activat â†’ domain preset la runtime

La /api/run/{moduleId}, dacÄƒ domain se potriveÈ™te cu un pack activ, injectezi domain_config preset din industry_packs.domain_config Ã®n parameter_set_7d È™i Ã®n prompt (stil, KPIs, guardrails).

// Pseudocod (API run)
const packs = await sql`select ip.slug, ip.domain_config from org_industry_packs oip join industry_packs ip on ip.slug=oip.pack_slug where oip.org_id=${org}`;
const domain = body.parameter_set_7d.domain; // "fintech" | "ecommerce" ...
if (packs.some(p => p.slug === domain)) {
  body.parameter_set_7d = applyDomainPreset(body.parameter_set_7d, packs.find(p=>p.slug===domain).domain_config);
}


FinTech: poate forÈ›a output_format: "spec" È™i Export requirement .spec+.json (vezi gating mai jos).

5) API & UI Gating (serverâ€‘side hard gate + UI soft gate)
5.1 Middleware server (Node/Deno/Edge)
type Gate = "canUseAllModules"|"canExportMD"|"canExportPDF"|"canExportJSON"|"canUseGptTestReal"|
            "hasCloudHistory"|"hasEvaluatorAI"|"hasAPI"|"hasWhiteLabel"|"canExportBundleZip"|"hasSeatsGT1";

async function gate(org: string, required: Gate[]): Promise<void> {
  const rows = await db.query(/* sql */`
    select flag, enabled from entitlements_effective
    where org_id = $1 and flag = any($2)`, [org, required]);
  const enabled = new Map(rows.map((r: any) => [r.flag, r.enabled]));
  for (const r of required) if (!enabled.get(r)) throw new PaywallError(r);
}


Exemple:

/api/run/:moduleId â†’ gate(org, ["canUseAllModules"])

dacÄƒ plan=Free È™i modulul nu e Ã®n allowlist â†’ 403 + X-Upsell: Creator

/api/export/pdf â†’ gate(org, ["canExportPDF"])

/api/test/gpt-live â†’ gate(org, ["canUseGptTestReal"])

/api/bundle.zip â†’ gate(org, ["canExportBundleZip"])

RegulÄƒ FinTech (export):

if (domain === "fintech") {
  // obligatoriu .spec + .json
  await gate(org, ["canExportJSON"]);         // plan Pro+
  requireFormats(["spec","json"], exportRequest); // altfel 422
}


ReturneazÄƒ HTTP 402/403 + payload upsell:

{
  "error": "PAYWALL",
  "missing_flag": "canExportPDF",
  "suggested_sku": "pro",
  "cta": "Upgrade to Pro to export PDF"
}

5.2 UI softâ€‘gate

La montarea paginii, clientul face GET /me/entitlements (agregat din entitlements_effective) È™i GET /me/plan_snapshot (din view).

Componentele ascund butoane sau afiÈ™eazÄƒ UpsellBanner cÃ¢nd lipsesc flagâ€‘uri.

CÃ¢nd utilizatorul schimbÄƒ domain â†’ dacÄƒ existÄƒ pack corespunzÄƒtor È™i nu e activ â†’ OpenPaywall("Activate FinTech Pack").

6) Audit & Trasabilitate

Tabele dedicate pentru audit evenimente & schimbÄƒri entitlements.

create table if not exists entitlements_audit (
  id bigserial primary key,
  org_id uuid not null,
  flag text not null,
  old_value boolean,
  new_value boolean,
  source entitlement_source,
  source_ref text,
  reason text,                         -- webhook|manual|migration
  actor text,                          -- "stripe:webhook"|"admin:email"
  at timestamptz default now()
);

-- Trigger pentru entitlements
create or replace function pf_audit_entitlements()
returns trigger language plpgsql as $$
begin
  insert into entitlements_audit(org_id, flag, old_value, new_value, source, source_ref, reason, actor)
  values (coalesce(new.org_id, old.org_id),
          coalesce(new.flag, old.flag),
          old.value, new.value,
          coalesce(new.source, old.source),
          coalesce(new.source_ref, old.source_ref),
          current_setting('pf.reason', true),
          current_setting('pf.actor', true));
  return new;
end; $$;

drop trigger if exists trg_entitlements_audit on entitlements;
create trigger trg_entitlements_audit
after insert or update or delete on entitlements
for each row execute function pf_audit_entitlements();


Best practices

Webhook seteazÄƒ GUCâ€‘uri: set local pf.reason = 'webhook'; set local pf.actor = 'stripe:webhook';.

UI Admin seteazÄƒ pf.reason='admin', pf.actor='admin:<email>'.

7) Edge cases & politici

Trial â†’ Active: la subscription.updated cu status='active' reaplici plan entitlements (idempotent).

Past_due: pÄƒstrezi entitlements dar pui grace period 3 zile (feature flag separat grace_active dacÄƒ vrei rafinament).

Cancel & Downgrade: customer.subscription.deleted â†’ pf_revoke_plan_entitlements; pÄƒstrezi istoricul Ã®n entitlements_audit.

Seat overage: dacÄƒ hasSeatsGT1=false È™i seats_used>1 â†’ blochezi invitaÈ›ii noi (UI) È™i Ã®n API 403 {cta: "Upgrade to Enterprise"}.

Plan < min_plan al unui pack: dacÄƒ org are fintech dar plan Creator â†’ gating API la /api/run (ceri upgrade la Pro).

RLS: toate tabelele au politicile pe org_id, deci nu scapi date crossâ€‘tenant.

8) Testare (scenarii minime)

Free â†’ Creator: verificÄƒ canUseAllModules trece TRUE; PDF/JSON rÄƒmÃ¢n FALSE.

Pro + FinTech Pack: /api/export/json permis; /api/bundle.zip blocat (nu Enterprise).

Downgrade Pro â†’ Creator: customer.subscription.updated â†’ pf_revoke_plan_entitlements + pf_apply_plan_entitlements("creator"); endpoint /api/test/gpt-live devine 403.

Eâ€‘Comm Pack fÄƒrÄƒ plan Pro: /api/run cu domain=ecommerce â†’ 403 + upsell pack/plan.

Audit trail: toate schimbÄƒrile apar Ã®n entitlements_audit cu actor='stripe:webhook'.

9) Integrare cu Exporter (din bundle.ts)

Ãnainte de zipBundle, fÄƒ gate:

await gate(org, ["canExportMD"]);            // pentru .md
if (request.includes("pdf")) await gate(org, ["canExportPDF"]);
if (request.includes("json")) await gate(org, ["canExportJSON"]);
if (request.includes("bundle.zip")) await gate(org, ["canExportBundleZip"]);


Pentru FinTech:

if (domain === "fintech") {
  requireFormats(["spec","json"], selection);
}

10) Endpointuri utile (API)

GET /me/entitlements â†’ { flags: {canExportPDF:true,...}, packs: ["fintech"] }

GET /me/plan_snapshot â†’ { plan_code, retention_days, module_allowlist }

POST /packs/activate â†’ Stripe Checkout link; pe checkout.session.completed â†’ pf_apply_pack.

POST /run/:moduleId â†’ hard gate canUseAllModules (+ allowlist pentru Free).






standard complet pentru Telemetry @ fiecare run Ã®n PROMPTFORGEâ„¢ v3: ce capturÄƒm, cum calculÄƒm (TTA, scoruri, tokeni, rata de eÈ™ec), cum legÄƒm la 7D, plus modele de date È™i queryâ€‘uri gata de folosit.

ğŸ¯ Ce mÄƒsori la fiecare run
0) Identitate & context

run_id (uuid), module_id (M01â€“M50), module_version (semver)

org_id, project_id, user_id

parameter_set_7d: {domain, scale, urgency, complexity, resources, application, output_format}

industry_pack activ (ex: fintech, ecommerce, education)

1) Timeline & TTA (Timeâ€‘Toâ€‘Artifact)

t_request (server receive)

t_plan_start â†’ t_plan_end

t_generate_start â†’ t_generate_end

t_evaluate_start â†’ t_evaluate_end

t_format_start â†’ t_format_end

t_export_start â†’ t_export_end

TTA = t_first_artifact - t_request

textâ€‘only: t_format_end - t_request

bundle: t_export_end - t_request

Breakdown (ms): plan_ms, generate_ms, evaluate_ms, format_ms, export_ms, total_ms

2) Model & cost

model: (ex. gpt-4o, gptâ€‘5â€‘thinking), temperature, seed, top_p

prompt_tokens, completion_tokens, total_tokens

cache_hits (oui/non), retries (#), fallbacks[] (ex: tighten, crisis_mode)

est_cost_usd (pricing map Ã— tokens)

3) Calitate (Test Engine)

scores: {clarity, execution, ambiguity, business_fit, composite} (0â€“100; ambiguitate inversÄƒ)

verdict: pass | partial_pass | fail

thresholds & weights folosite (logate pentru audit)

evaluator_feedback (rezumat 1â€“3 linii)

4) Policy & compliance

policy_hits[]: GDPR, IP, medical/financiar, domeniuâ€‘specific (ex: SEC/FCA)

redactions: cÃ¢te cÃ¢mpuri au fost anonimizate

safety_blocked: boolean (dacÄƒ a tÄƒiat conÈ›inutul neconform)

5) Export & rezultate

artifacts[]: ["txt","md","json","pdf"] generate

export_ok: boolean

checksum_sha256 (per fiÈ™ier) & bundle_id (dacÄƒ Enterprise)

manifest_signature (dacÄƒ Enterprise whitelabel)

6) Stare & erori

status: ok | partial | fail

error_code (ex: PAYWALL_MISSING_FLAG, MODEL_TIMEOUT, POLICY_BLOCK)

error_message (scurt, nonâ€‘PII)

ğŸ“ KPI derivate (pe fereastrÄƒ de timp)

TTA p50/p90/p95 (text vs bundle)

RatÄƒ eÈ™ec = #runs_fail / #runs_total

opÈ›ional â€rata partialâ€ = #partial_pass / #runs_total

Tokeni/artefact (medie & p95)

Cost/artefact (USD)

Export success rate = #export_ok / #runs_total

Quality pass rate = #verdict=pass / #runs_total

Policy hit rate = #policy_hits>0 / #runs_total

Segmentare standard: pe domain 7D, module, industry_pack, plan (Free/Creator/Pro/Ent), org.

ğŸ§± Model de date (Supabase)
runs (extinde tabelul existent)

id uuid pk (run_id)

prompt_version_id uuid fk

parameter_set_7d jsonb

status text (ok|partial|fail)

telemetry jsonb â† payloadul de mai jos

created_at timestamptz

scores (existÄƒ deja)

cÃ¢mpurile scorurilor + composite + verdict (0â€“100, etc.)

telemetry_events (opÈ›ional, granular)

run_id uuid fk, phase text (plan|generate|evaluate|format|export|policy|gate)

event text, meta jsonb, at timestamptz

ğŸ§© Payload JSON (per run â€” exemplu)
{
  "run_id": "6a2f0f5a-0d0e-4d1e-9df1-6e8d93b9a111",
  "module_id": "M14",
  "module_version": "1.2.0",
  "org_id": "7f1c...e2a",
  "parameter_set_7d": {
    "domain": "saas",
    "scale": "startup",
    "urgency": "sprint",
    "complexity": "advanced",
    "resources": "lean_team",
    "application": "implementation",
    "output_format": "spec"
  },
  "industry_pack": null,
  "timeline": {
    "t_request": "2025-08-19T09:00:00.000Z",
    "t_plan_start": "2025-08-19T09:00:00.010Z",
    "t_plan_end": "2025-08-19T09:00:00.080Z",
    "t_generate_start": "2025-08-19T09:00:00.081Z",
    "t_generate_end": "2025-08-19T09:00:01.250Z",
    "t_evaluate_start": "2025-08-19T09:00:01.251Z",
    "t_evaluate_end": "2025-08-19T09:00:01.430Z",
    "t_format_start": "2025-08-19T09:00:01.431Z",
    "t_format_end": "2025-08-19T09:00:01.520Z",
    "t_export_start": "2025-08-19T09:00:01.521Z",
    "t_export_end": "2025-08-19T09:00:01.880Z"
  },
  "latency_ms": {
    "plan": 70, "generate": 1169, "evaluate": 179, "format": 89, "export": 359, "total": 1880,
    "tta": 1520
  },
  "model": {"name":"gpt-5-thinking","temperature":0.4,"seed":42},
  "tokens": {"prompt": 820, "completion": 910, "total": 1730, "cache_hits": true, "retries": 0},
  "cost": {"est_usd": 0.32},
  "scores": {"clarity": 88, "execution": 83, "ambiguity": 12, "business_fit": 79, "composite": 84.1, "verdict": "partial_pass"},
  "policy": {"hits": ["gdpr"], "redactions": 1, "safety_blocked": false},
  "export": {"artifacts": ["txt","md","json","pdf"], "export_ok": true, "checksums": {"prompt.md":"sha256:..."}},
  "status": "ok",
  "error": null
}

ğŸ“Š Queryâ€‘uri rapide (KPIâ€‘uri)

TTA p95 (bundle) pe domeniu 7D

select (parameter_set_7d->>'domain') as domain,
       percentile_cont(0.95) within group (order by (telemetry->'latency_ms'->>'tta')::int) as tta_p95_ms
from runs
where telemetry->'export'->>'export_ok' = 'true'
group by domain
order by tta_p95_ms asc;


RatÄƒ eÈ™ec pe modul

select module_id,
  avg((status='fail')::int)::numeric(5,2) as fail_rate
from runs
where created_at >= now() - interval '30 days'
group by module_id
order by fail_rate desc;


Tokeni medii per artefact (p95)

select (parameter_set_7d->>'output_format') as fmt,
       percentile_cont(0.95) within group (order by (telemetry->'tokens'->>'total')::int) as tokens_p95
from runs
group by fmt;


Quality pass rate (global & pe pack)

select coalesce(industry_pack,'none') as pack,
       avg((scores.verdict='pass')::int) as pass_rate
from runs r
join scores s on s.run_id = r.id
group by pack
order by pass_rate desc;

ğŸ›ï¸ SLO/alertare recomandate

TTA p95:

text: â‰¤ 60s

SOP/Bundle: â‰¤ 5min

Fail rate 7d: < 2% (hard), < 5% (warning)

Ambiguity: p90 â‰¤ 20

Composite: medie â‰¥ 80

Export success: â‰¥ 98%

Alerte (Supabase + cron/Edge Function) â†’ Slack/Email cu top module/domeniu care Ã®ncalcÄƒ SLOâ€‘uri.

ğŸ§ª Calculul exact al TTA

TTA text = t_format_end - t_request (primul artefact util)

TTA bundle = t_export_end - t_request

DacÄƒ exportul e dezactivat (plan/policy), TTA se opreÈ™te la primul artefact promis de modul (de obicei .md/.spec).

Loghezi Ã®ntotdeauna ambele: tta_first_artifact È™i (dacÄƒ existÄƒ) tta_bundle.

ğŸ” NotÄƒ de conformitate

Nu loga PII Ã®n error_message sau evaluator_feedback.

policy_hits doar etichete (fÄƒrÄƒ text sensibil).

Hashâ€‘uieÈ™te sursele (ex. src_hash) dacÄƒ salvezi provenance Ã®n FinTech/Healthcare.






ritualul operaÈ›ional pentru PROMPTFORGEâ„¢ v3 ca sÄƒ ai disciplinÄƒ de produs, control de calitate È™i trasabilitate completÄƒ:

âœ… Definition of Ready (DoR)

Un modul / feature intrÄƒ Ã®n lucru doar dacÄƒ are:

Contract scris (input â†’ output, KPI, guardrails)

Parametrizare 7D stabilitÄƒ (domain, scale, urgency, complexity, resources, application, output)

Entitlements clare (ce plan/pack Ã®l poate accesa)

Cazuri de test â€goldenâ€ definite (3â€“5 exemple de input + output aÈ™teptat)

âœ… Definition of Done (DoD)

Se considerÄƒ finalizat numai dacÄƒ:

RuleazÄƒ pe /api/run/{moduleId} cu gating activ (plan/entitlements)

ExportÄƒ bundle complet: .txt/.md/.json/.pdf + checksum

Telemetrie salvatÄƒ: tokens, cost, TTI, scor Evaluator

Versionare marcatÄƒ (module_versions.semver + changelog)

RLS activ pe tabele Supabase (org_id enforced)

ğŸ” Code Review de Prompt

Proces canonic:

Spec check â€” verifici dacÄƒ structura promptului include context â†’ cerinÈ›e â†’ spec â†’ KPI â†’ guardrails â†’ fallback

Evaluator AI â€” scoruri 0â€“100 pe claritate, execuÈ›ie, ambiguitate, alignment, business_fit

Feedback â€” Reviewer adaugÄƒ micro-optimizÄƒri: â€Tighten toneâ€, â€Optimize for Enterpriseâ€

Golden test â€” rulare pe GPT live È™i comparaÈ›ie cu output-urile salvate Ã®n modules/Mxx/examples/*.json

ğŸ“† Release Cadence

SÄƒptÄƒmÃ¢nal â€” patch release (vX.Y.Z â†’ Z+1): bugfix, tuning KPI.

Bilunar â€” minor release (vX.Y.Z â†’ Y+1.0): module noi, Industry Packs.

Trimestrial â€” major release (X+1.0.0): schimbÄƒri Ã®n engine (Evaluator, Bundle, Telemetrie).

Artefacte livrate la fiecare release:

Export .bundle.zip (module updated + changelog + telemetry schema)

Changelog generativ Ã®n modules/versions.json È™i lib/versioning/**

ğŸ“ Change Log

StructurÄƒ standard (semver + sursÄƒ schimbare):

version: v3.2.0
date: 2025-08-19
changes:
  - module: M07 Risk & Trust Reversal
    type: improvement
    source: "feedback Evaluator AI"
    detail: "Clarify refund guardrail; KPI drop-off now -30%"
  - module: M22 SOP Lead Gen
    type: fix
    source: "telemetry policy_hits"
    detail: "Blocked invalid trigger in crisis mode"
  - core: Export Bundle
    type: feature
    source: "enterprise entitlement"
    detail: "Added .yaml export option"


â†’ Persistat Ã®n module_versions È™i livrat ca artefact Ã®n bundle

Astfel, ritualul operaÈ›ional face ca fiecare clic â†’ prompt â†’ bundle sÄƒ fie validabil, trasabil È™i monetizabil.
