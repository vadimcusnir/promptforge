




definiÈ›iile mecanice pentru DoR / DoD Ã®n PROMPTFORGEâ„¢, cu condiÈ›ii de verificare executabile (poÈ›i transpune direct Ã®n cod/SQL/CI rules).

âœ… Definition of Ready (DoR)

Un modul/rulare este â€Readyâ€ doar dacÄƒ sunt bifate toate:

7D valid

Toate cÃ¢mpurile obligatorii (domain, output) sunt prezente.

Fiecare parametru âˆˆ enum (vezi ruleset.yml).

signature_7d calculatÄƒ È™i persistatÄƒ.

Entitlement valid

Planul curent (Pilot, Pro, Enterprise) acoperÄƒ modulul M## ales.

Cheile industry_keys includ domeniul (sevenD.domain).

Feature_flags necesare pentru export/test sunt active.

Output Spec Ã®ncÄƒrcat

module.spec.json.outputs.fields este disponibil È™i complet.

Contractul OUTPUT_SPEC are format + cÃ¢mpuri + exemplu.

Testcases definite

module.spec.json.tests[] existÄƒ, cu input + assert non-gol.

Minim 1 test validat de schema (assert.output_spec_complete = true).

Input minim existent

Parametrii inputs.custom conÈ›in cel puÈ›in cÃ¢mpurile required din schema modulului.

Lipsurile non-critice sunt completate cu fallback ([TBD]).

âœ… Definition of Done (DoD)

O rulare/bundle este â€Doneâ€ doar dacÄƒ:

Scor â‰¥ 80

Evaluator (clarity + execution + ambiguity + business_fit) â‰¥ threshold din ruleset.yml.

DacÄƒ <80 â†’ tighten o singurÄƒ iteraÈ›ie; dacÄƒ rÄƒmÃ¢ne <80 â‡’ FAIL, nu â€Doneâ€.

Output complet

Toate cÃ¢mpurile din outputs.fields marcate required=true sunt populate.

Formatul respectÄƒ output_spec_contract (ex: JSON valid, markdown structurat, checklist complet).

Nicio secÈ›iune obligatorie din prompt_standard nu e lipsÄƒ.

Checksum valid

FiÈ™ierele exportate (txt|md|pdf|json) au hash sha256 calculat.

Hash-urile coincid cu cele listate Ã®n export.manifest.json.

Manifest scris

export.manifest.json existÄƒ Ã®n bundle.

ConÈ›ine cÃ¢mpuri minime: project, module, run_id, sevenD, files, score, kpi, license_notice, created_at.

license_notice prezent È™i mapat corect la plan.

Telemetrie salvatÄƒ

Ãn tabel runs: run_id, module_code, semver, final_7d, scores, tta_seconds, tokens_in/out, entitlements_snapshot.

FÄƒrÄƒ conÈ›inut brut client â†’ doar hashuri È™i scoruri.

Status final marcat success.

ğŸ”§ Rezumat implementare

DoR Check (pseudocod)

function checkDoR(run) {
  return run.sevenD.valid && run.entitlements.valid &&
         run.moduleSpec.outputs && run.moduleSpec.tests.length > 0 &&
         run.inputsCustom.hasAllRequired;
}


DoD Check (pseudocod)

function checkDoD(bundle) {
  return bundle.score >= 80 &&
         bundle.outputs.requiredFieldsComplete &&
         bundle.checksum.valid &&
         bundle.manifest.exists && bundle.manifest.license_notice &&
         telemetrySaved(bundle.run_id);
}







import yaml
from pathlib import Path

rules = {
  "ruleset": "PROMPTFORGE_v3",
  "semver": "0.1.0",
  "DoR": {
    "description": "Definition of Ready",
    "conditions": [
      {"id": "7d_valid", "desc": "7D complet, valori âˆˆ enum, signature calculatÄƒ", "required": True},
      {"id": "entitlement_valid", "desc": "Planul È™i domain entitlement sunt valide", "required": True},
      {"id": "output_spec_loaded", "desc": "Output spec prezent È™i complet Ã®n module.spec.json", "required": True},
      {"id": "tests_defined", "desc": "Cel puÈ›in un testcase definit Ã®n modul", "required": True},
      {"id": "input_minimum", "desc": "Inputs.custom conÈ›in toate cÃ¢mpurile required", "required": True}
    ]
  },
  "DoD": {
    "description": "Definition of Done",
    "conditions": [
      {"id": "score_threshold", "desc": "Scor total â‰¥ 80", "required": True},
      {"id": "output_complete", "desc": "Toate cÃ¢mpurile required din outputs.fields sunt populate", "required": True},
      {"id": "checksum_valid", "desc": "FiÈ™ierele exportate au hash sha256 valid È™i verificat", "required": True},
      {"id": "manifest_written", "desc": "Manifest export.manifest.json existÄƒ È™i e complet", "required": True},
      {"id": "telemetry_saved", "desc": "Telemetria pentru run este persistatÄƒ Ã®n DB (fÄƒrÄƒ content brut)", "required": True}
    ]
  }
}







aici sunt KPI & SLA formulate ca reguli de control permanent Ã®n PROMPTFORGEâ„¢. Le-am structurat Ã®n douÄƒ straturi: KPI (metrici de performanÈ›Äƒ pe fiecare run) È™i SLA (angajamente operaÈ›ionale pe perioade lungi).

ğŸ“Š KPI (Key Performance Indicators) â€” per run

TTA text < 60s

Timpul de generare a artefactelor text (prompt.txt / prompt.md) â‰¤ 60 sec.

Se mÄƒsoarÄƒ din started_at â†’ finished_at (tabel runs).

AlertÄƒ: dacÄƒ P95 > 60 sec.

TTA SOP < 300s

Artefactele SOP (planuri complexe, bundle) â‰¤ 300 sec.

SLA intern = P95 sub 300s.

Score â‰¥ 80

Evaluator (clarity + execution + ambiguity + business_fit) â‰¥ threshold din ruleset.yml.

DacÄƒ <80 â‡’ tighten (max. 1 iteraÈ›ie). DacÄƒ rÄƒmÃ¢ne <80 â‡’ FAIL.

Export OK

Bundle exportat complet cu toate fiÈ™ierele (txt, md, pdf, json).

Checksum sha256 valid + manifest complet (license_notice, score, kpi, created_at).

Zero leak PII

Nicio informaÈ›ie personalÄƒ brutÄƒ Ã®n bundle sau telemetrie.

Se aplicÄƒ DLP (Data Loss Prevention) rules: orice match â‡’ blocare export public.

dlp_summary Ã®n manifest trebuie sÄƒ fie no PII.

ğŸ“ˆ SLA (Service Level Agreement) â€” agregat

Disponibilitate operaÈ›ionalÄƒ

â‰¥ 99% din rulÄƒri finalizeazÄƒ bundle cu succes (PASS) fÄƒrÄƒ erori.

Se calculeazÄƒ la nivel de sÄƒptÄƒmÃ¢nÄƒ/lunÄƒ.

PerformanÈ›Äƒ runde rapide

â‰¥ 99% din runde complete (de la run_start la bundle_ready) Ã®n â‰¤120 sec.

Outlier runs (>120s) se raporteazÄƒ separat (sla_outliers).

Stabilitate scoruri

P95 Score â‰¥ 80 pe ultimele 7 zile.

DeviaÈ›ia KPI pe fiecare axÄƒ (clarity/execution/ambiguity/business_fit) <10% faÈ›Äƒ de medianÄƒ.

Conformitate export

100% bundle-uri au manifest + checksum valid.

100% bundle-uri au license_notice conform plan.

ğŸ”§ Implementare Ã®n monitorizare
Tabele SQL (Supabase)

KPI per run

select run_id, 
       (finished_at - started_at) as tta_seconds,
       score_total, 
       (export_status='success') as export_ok,
       (dlp_summary='no PII') as zero_leak
from runs
where created_at >= now() - interval '1 day';


SLA agregat (7 zile)

select
  count(*) filter (where status='success') * 100.0 / count(*) as pass_rate_pct,
  count(*) filter (where (finished_at - started_at) <= interval '120 seconds') * 100.0 / count(*) as sla_fast_pct,
  percentile_cont(0.95) within group (order by score_total) as p95_score,
  percentile_cont(0.95) within group (order by finished_at - started_at) as p95_tta
from runs
where created_at >= now() - interval '7 days';

Alarme

PASS rate <99% (sÄƒptÄƒmÃ¢nÄƒ) â‡’ alertÄƒ roÈ™ie.

P95 TTA >120s â‡’ alertÄƒ galbenÄƒ.

Orice bundle fÄƒrÄƒ manifest/checksum â‡’ incident critic.

Orice dlp_summary â‰  no PII â‡’ blocare export public + incident security.











# Create a detailed ruleset.yml for PROMPTFORGE_v3 and save it for download
ruleset = """# PROMPTFORGE v3 â€” ruleset.yml (SSOT)
project: PROMPTFORGE_v3
description: >-
  Nucleul de configurare (Single Source of Truth) pentru motorul PROMPTFORGE v3.
  Doar acest fiÈ™ier poate defini/override valorile default. UI-ul NU poate scrie aici.
schema_version: 1
semver: 0.1.0
is_ssot: true

# --- Politici SSOT & compatibilitate ---
policies:
  defaults_editable_only_here: true
  ui_cannot_override_defaults: true
  compatibility:
    signature_fields: [domain, scale, application, output]   # ce iese din Mn intrÄƒ Ã®n Mn+1 doar dacÄƒ semnÄƒtura 7D/ subset se potriveÈ™te
  security:
    knowledge_scoping_tag: safe_to_use   # doar fiÈ™iere/tabele marcate astfel pot fi folosite de module
    pii_public_export: anonymize         # anonimizare la export public
  telemetry:
    do_not_log_raw_client_content: true

# --- EnumerÄƒri 7D & reguli motor ---
sevenD:
  required: [domain, output]
  enums:
    domain: [MKT, EDU, SAAS, HEALTH, FIN, GOV, MEDIA, HR, LEGAL, ECOM, NONPROFIT, CYBER, REAL_ESTATE, HOSPITALITY, TRAVEL, GAMING, MANUFACTURING, ENERGY, TRANSPORT, AGRI, SPORTS, MUSIC, ART, NEWS, SCIENCE, TELECOM, AUTOMOTIVE]
    scale: [solo, team, org, market]
    urgency: [low, normal, high, crisis]
    complexity: [low, medium, high]
    resources: [minimal, standard, extended]
    application: [content_ops, sales_ops, product_ops, research, crisis_ops]
    output: [text, sop, plan, bundle]
  aliases:
    # AcceptÄƒm sinonime Ã®n input, le mapÄƒm la valorile canonice (enum-only la runtime).
    scale: { program: org, department: org }
    output: { document: text, pack: bundle }
  validation:
    enum_only: true         # blocheazÄƒ rulÄƒri dacÄƒ existÄƒ valori Ã®n afara enumerÄƒrilor
    raise_on_invalid: true  # eroare hard la prima abatere 7D
  fallback:
    by_domain_defaults: true  # dacÄƒ lipsesc dimensiuni, foloseÈ™te defaults de domeniu
  variability:
    diversity_budget:
      applies_to: [style, angle]
      not_applied_to: [facts]
      range: { min: 0.0, max: 1.0 }
      default: 0.2

# --- Defaults pe domeniu (pot fi extinse; acestea sunt SSOT) ---
defaults_template: &defaults_base
  scale: team
  urgency: normal
  complexity: medium
  resources: standard
  application: content_ops
  output: bundle

domains:
  - code: MKT
    name: Marketing
    defaults: *defaults_base

  - code: EDU
    name: Education
    defaults:
      <<: *defaults_base
      scale: org
      application: course_ops

  - code: SAAS
    name: B2B SaaS
    defaults:
      <<: *defaults_base
      application: product_ops

  - code: HEALTH
    name: Healthcare
    defaults:
      <<: *defaults_base
      urgency: high
      application: research

  - code: FIN
    name: Finance
    defaults:
      <<: *defaults_base
      complexity: high

  - code: GOV
    name: Government
    defaults:
      <<: *defaults_base
      scale: org
      urgency: normal
      application: research

  - code: MEDIA
    name: Media & Publishing
    defaults: *defaults_base

  # Domeniile rÄƒmase moÈ™tenesc *defaults_base dacÄƒ nu sunt declarate explicit.
  # AdaugÄƒ noi domenii aici numai cu codul din enums.domain.

# --- Prompt standard universal (secÈ›iuni fixe) ---
prompt_standard:
  sections: [ROLE_GOAL, CONTEXT_7D, OUTPUT_SPEC, PROCESS, GUARDRAILS, EVALUATION_HOOKS, TELEMETRY_KEYS]
  non_deletable_in_ui: true
  output_spec_contract:
    must_define_fields: [format, fields, example]
    example_minimal:
      format: markdown
      fields: [title, sections, kpi]
      example: |
        # Titlu
        - SecÈ›iune 1
        - SecÈ›iune 2
        KPI: {...}

# --- Test & Score ---
test:
  rubric: [clarity, execution, ambiguity, business_fit]
  threshold: 80
  auto_fix:
    enabled: true
    max_iterations: 1

# --- Export & checksum ---
export:
  structure: standard_bundle
  bundle_path_template: "/bundles/{project}/{date}/{domain}/{module}/{slug}/"
  artifacts: ["prompt.txt","prompt.json","prompt.md","prompt.pdf","manifest.json","checksum.sha256"]
  checksum:
    algo: sha256
    include: ["prompt.txt","prompt.json","prompt.md","prompt.pdf","manifest.json"]

# --- Entitlements & planuri ---
entitlements:
  plans:
    Pilot:
      modules: "M01-M10"
      features: [txt, md]
      limits: { runs_per_day: 20 }
    Pro:
      modules: "M01-M30"
      features: [txt, md, pdf, cloud_history]
      limits: { runs_per_day: 100 }
    Enterprise:
      modules: "M01-M50"
      features: [api, multi_industry, audit]
      limits: { runs_per_day: 1000 }
  ui_rules:
    hide_modules_without_entitlement: true
    block_endpoints_without_entitlement: true

# --- Telemetrie ---
telemetry:
  keys: [tta_seconds, score, tokens_in, tokens_out, domain, module, plan]
  slo:
    tta_text_seconds_p95: 60
    tta_sop_seconds_p95: 300

# --- Versiuni & istoric ---
versioning:
  store: supabase
  tables: [projects, modules, runs, bundles, entitlements, plans, industries]
  change_policies:
    defaults_only_editable_here: true
    log_every_override: true
  migrations:
    semver_major_requires_compat_script: true

# --- License notice ---
license:
  manifest_required_field: license_notice
  default_notice:
    Pilot: "PFv3 Pilot"
    Pro: "PFv3 Pro"
    Enterprise: "PFv3 Enterprise"

"""
with open("/mnt/data/ruleset.yml", "w", encoding="utf-8") as f:
    f.write(ruleset)
"/mnt/data/ruleset.yml"
Rezultat
'/mnt/data/ruleset.yml'
perfect â€” iatÄƒ varianta â€nucleuâ€ pentru ruleset.yml, completatÄƒ cu politici SSOT, enumâ€‘uri stricte, fallback pe domeniu, compatibilitate pe semnÄƒtura 7D, export & checksum, entitlements È™i telemetrie. Am inclus aliasuri (ex. programâ†’org) ca sÄƒ pÄƒstrÄƒm inputurile istorice dar sÄƒ menÈ›inem validarea â€œenumâ€‘onlyâ€.

yaml
CopiazÄƒ
EditeazÄƒ
# PROMPTFORGE v3 â€” ruleset.yml (SSOT)
project: PROMPTFORGE_v3
description: >-
  Nucleul de configurare (Single Source of Truth) pentru motorul PROMPTFORGE v3.
  Doar acest fiÈ™ier poate defini/override valorile default. UI-ul NU poate scrie aici.
schema_version: 1
semver: 0.1.0
is_ssot: true

policies:
  defaults_editable_only_here: true
  ui_cannot_override_defaults: true
  compatibility:
    signature_fields: [domain, scale, application, output]   # Mn â†’ Mn+1 doar dacÄƒ semnÄƒtura 7D (sau subsetul ei) se potriveÈ™te
  security:
    knowledge_scoping_tag: safe_to_use   # doar resurse marcate astfel sunt eligibile la rulare
    pii_public_export: anonymize         # anonimizÄƒm PII la exporturi publice
  telemetry:
    do_not_log_raw_client_content: true  # nu logÄƒm conÈ›inut brut al clientului

sevenD:
  required: [domain, output]
  enums:
    domain: [MKT, EDU, SAAS, HEALTH, FIN, GOV, MEDIA, HR, LEGAL, ECOM, NONPROFIT, CYBER, REAL_ESTATE, HOSPITALITY, TRAVEL, GAMING, MANUFACTURING, ENERGY, TRANSPORT, AGRI, SPORTS, MUSIC, ART, NEWS, SCIENCE, TELECOM, AUTOMOTIVE]
    scale: [solo, team, org, market]
    urgency: [low, normal, high, crisis]
    complexity: [low, medium, high]
    resources: [minimal, standard, extended]
    application: [content_ops, sales_ops, product_ops, research, crisis_ops]
    output: [text, sop, plan, bundle]
  aliases:
    scale: { program: org, department: org }    # sinonime care se mapeazÄƒ la valorile canonice
    output: { document: text, pack: bundle }
  validation:
    enum_only: true
    raise_on_invalid: true
  fallback:
    by_domain_defaults: true
  variability:
    diversity_budget:
      applies_to: [style, angle]
      not_applied_to: [facts]
      range: { min: 0.0, max: 1.0 }
      default: 0.2

defaults_template: &defaults_base
  scale: team
  urgency: normal
  complexity: medium
  resources: standard
  application: content_ops
  output: bundle

domains:
  - code: MKT
    name: Marketing
    defaults: *defaults_base

  - code: EDU
    name: Education
    defaults:
      <<: *defaults_base
      scale: org
      application: course_ops

  - code: SAAS
    name: B2B SaaS
    defaults:
      <<: *defaults_base
      application: product_ops

  - code: HEALTH
    name: Healthcare
    defaults:
      <<: *defaults_base
      urgency: high
      application: research

  - code: FIN
    name: Finance
    defaults:
      <<: *defaults_base
      complexity: high

  - code: GOV
    name: Government
    defaults:
      <<: *defaults_base
      scale: org
      application: research

  - code: MEDIA
    name: Media & Publishing
    defaults: *defaults_base

  # Domeniile nedeclarate explicit moÈ™tenesc *defaults_base.

prompt_standard:
  sections: [ROLE_GOAL, CONTEXT_7D, OUTPUT_SPEC, PROCESS, GUARDRAILS, EVALUATION_HOOKS, TELEMETRY_KEYS]
  non_deletable_in_ui: true
  output_spec_contract:
    must_define_fields: [format, fields, example]
    example_minimal:
      format: markdown
      fields: [title, sections, kpi]
      example: |
        # Titlu
        - SecÈ›iune 1
        - SecÈ›iune 2
        KPI: {...}

test:
  rubric: [clarity, execution, ambiguity, business_fit]
  threshold: 80
  auto_fix:
    enabled: true
    max_iterations: 1

export:
  structure: standard_bundle
  bundle_path_template: "/bundles/{project}/{date}/{domain}/{module}/{slug}/"
  artifacts: ["prompt.txt","prompt.json","prompt.md","prompt.pdf","manifest.json","checksum.sha256"]
  checksum:
    algo: sha256
    include: ["prompt.txt","prompt.json","prompt.md","prompt.pdf","manifest.json"]

entitlements:
  plans:
    Pilot:
      modules: "M01-M10"
      features: [txt, md]
      limits: { runs_per_day: 20 }
    Pro:
      modules: "M01-M30"
      features: [txt, md, pdf, cloud_history]
      limits: { runs_per_day: 100 }
    Enterprise:
      modules: "M01-M50"
      features: [api, multi_industry, audit]
      limits: { runs_per_day: 1000 }
  ui_rules:
    hide_modules_without_entitlement: true
    block_endpoints_without_entitlement: true

telemetry:
  keys: [tta_seconds, score, tokens_in, tokens_out, domain, module, plan]
  slo:
    tta_text_seconds_p95: 60
    tta_sop_seconds_p95: 300

versioning:
  store: supabase
  tables: [projects, modules, runs, bundles, entitlements, plans, industries]
  change_policies:
    defaults_only_editable_here: true
    log_every_override: true
  migrations:
    semver_major_requires_compat_script: true

license:
  manifest_required_field: license_notice
  default_notice:
    Pilot: "PFv3 Pilot"
    Pro: "PFv3 Pro"
    Enterprise: "PFv3 Enterprise"





# Generate two files for the user:
# 1) module.spec.schema.json  (JSON Schema validator for module specs)
# 2) module.spec.json         (a complete, copy-ready module spec template for M07)

import json, os, textwrap, hashlib, datetime, uuid

schema = {
  "$id": "https://promptforge.v3/schemas/module.spec.schema.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "PROMPTFORGE v3 Module Spec",
  "type": "object",
  "additionalProperties": False,
  "required": ["module_code","vector","name","purpose","inputs","outputs","tests","kpi","guardrails","deps","semver"],
  "properties": {
    "module_code": { "type":"string", "pattern":"^M\\d{2}$" },
    "vector": {
      "oneOf":[
        {"type":"integer","minimum":1,"maximum":7},
        {"type":"string","enum":["Strategic","Retoric","ConÈ›inut","Cognitiv","Memetic","Date","CrizÄƒ"]}
      ]
    },
    "name": {"type":"string","minLength":3,"maxLength":80},
    "purpose": {"type":"string","minLength":3,"maxLength":280},
    "tags": {"type":"array","items":{"type":"string"},"maxItems":10},
    "status": {"type":"string","enum":["draft","stable","deprecated"],"default":"stable"},
    "semver": {"type":"string","pattern":"^\\d+\\.\\d+\\.\\d+$"},
    "inputs": {
      "type":"object",
      "required":["schema","sevenD_contract"],
      "additionalProperties": False,
      "properties": {
        "sevenD_contract": {
          "type":"object",
          "description":"Contractul 7D (mapat din ruleset). AcceptÄƒ doar enum-uri È™i cere domain+output.",
          "additionalProperties": True
        },
        "schema": {
          "type":"object",
          "description":"JSON Schema pentru inputs.custom (UI form + validare).",
          "additionalProperties": True,
          "properties": {
            "type": {"const":"object"},
            "required": {"type":"array","items":{"type":"string"}},
            "properties": {"type":"object"}
          }
        },
        "example": {"type":"object"}
      }
    },
    "outputs": {
      "type":"object",
      "required":["artifact_type","fields"],
      "additionalProperties": False,
      "properties": {
        "artifact_type": {"type":"string","enum":["txt","md","checklist","spec","playbook","json","yaml","diagram","bundle","pdf"]},
        "fields": {
          "type":"array","minItems":1,
          "items": {
            "type":"object","additionalProperties": False,
            "required":["name","type","required"],
            "properties": {
              "name":{"type":"string"},
              "type":{"type":"string","enum":["string","number","boolean","array","object","markdown","json"]},
              "required":{"type":"boolean"},
              "pattern":{"type":"string"},
              "example":{},
              "minLength":{"type":"integer","minimum":0},
              "maxLength":{"type":"integer","minimum":1}
            }
          }
        },
        "example": {}
      }
    },
    "kpi": {
      "type":"object","additionalProperties": True,
      "required":["score_min"],
      "properties": {
        "score_min":{"type":"integer","minimum":0,"maximum":100},
        "tta_text_s":{"type":"integer","minimum":0},
        "tta_sop_s":{"type":"integer","minimum":0},
        "weights":{"type":"object","properties":{
          "clarity":{"type":"number"},"execution":{"type":"number"},
          "ambiguity":{"type":"number"},"business_fit":{"type":"number"}
        }}
      }
    },
    "tests": {
      "type":"array","minItems":1,
      "items": {
        "type":"object","additionalProperties": False,
        "required":["id","name","input","assert"],
        "properties": {
          "id":{"type":"string"},
          "name":{"type":"string"},
          "input":{"type":"object"},
          "assert":{
            "type":"object","additionalProperties": False,
            "properties":{
              "kpi_min":{"type":"integer","minimum":0,"maximum":100},
              "schema_ok":{"type":"boolean"},
              "output_spec_complete":{"type":"boolean"},
              "no_promises":{"type":"boolean"},
              "facts_grounded":{"type":"boolean"},
              "contains":{"type":"array","items":{"type":"string"}},
              "not_contains":{"type":"array","items":{"type":"string"}}
            }
          }
        }
      }
    },
    "guardrails": {
      "type":"object","additionalProperties": False,
      "required":["no_unfounded_claims","respect_style","privacy_safe"],
      "properties": {
        "no_promises":{"type":"boolean","default":True},
        "no_unfounded_claims":{"type":"boolean"},
        "privacy_safe":{"type":"boolean"},
        "respect_style":{"type":"boolean"},
        "confidentiality":{"type":"boolean","default":True},
        "style_rules":{"type":"array","items":{"type":"string"}}
      }
    },
    "deps": {
      "type":"array",
      "items":{
        "type":"object","additionalProperties": False,
        "required":["module_code","version_range","signature_7d_match"],
        "properties":{
          "module_code":{"type":"string","pattern":"^M\\d{2}$"},
          "version_range":{"type":"string"},
          "signature_7d_match":{"type":"boolean"}
        }
      }
    },
    "evaluation_hooks": {"type":"array","items":{"type":"string"}},
    "telemetry_keys": {"type":"array","items":{"type":"string"}}
  }
}

module_spec = {
  "module_code": "M07",
  "vector": "Strategic",
  "name": "Opportunity Map",
  "purpose": "MapeazÄƒ vectori de creÈ™tere Ã®n 7D È™i recomandÄƒ prioritizarea execuÈ›ionalÄƒ pe termen 30/90/180 zile.",
  "tags": ["growth","strategy","marketing"],
  "status": "stable",
  "semver": "0.1.0",
  "inputs": {
    "sevenD_contract": {
      "required": ["domain", "output"],
      "output_must_be_one_of": ["text","plan","bundle"]
    },
    "schema": {
      "type": "object",
      "required": ["goal","audience"],
      "properties": {
        "goal": { "type": "string", "minLength": 8, "description": "Obiectiv mÄƒsurabil de creÈ™tere", "example": "CreÈ™tere MQL +30% Ã®n Q4" },
        "audience": { "type": "string", "enum": ["B2B","B2C"], "example":"B2B" },
        "constraints": { "type": "array", "items": {"type":"string"}, "description":"LimitÄƒri/riscuri cunoscute", "example": ["buget < 5k","fÄƒrÄƒ paid ads"] },
        "time_horizon": { "type": "string", "enum": ["30d","90d","180d"], "default": "90d" },
        "diversity_budget": { "type": "number", "minimum": 0, "maximum": 1, "default": 0.2 }
      }
    },
    "example": { "goal": "CreÈ™tere MQL +30%", "audience":"B2B", "constraints":["buget < 5k"], "time_horizon":"90d" }
  },
  "outputs": {
    "artifact_type": "md",
    "fields": [
      {"name":"title","type":"markdown","required":True,"example":"Opportunity Map â€” FinTech (Q4)"},
      {"name":"context","type":"markdown","required":True},
      {"name":"opportunities","type":"array","required":True,"example":[{"name":"SEO cluster X","impact":"high","effort":"medium"}]},
      {"name":"risks","type":"array","required":True},
      {"name":"prioritization","type":"json","required":True,"example":{"method":"RICE","table":[{"name":"SEO","RICE":42}]}},
      {"name":"next_actions","type":"array","required":True,"example":[{"owner":"PMM","due":"2025-09-15","priority":"P1"}]},
      {"name":"metrics","type":"json","required":True,"example":{"north_star":"MQL","leading":["CTR blog","signup rate"]}},
      {"name":"open_questions","type":"array","required":False}
    ],
    "example": "# Opportunity Map\n\n## Context\n...\n"
  },
  "kpi": {
    "score_min": 80,
    "weights": {"clarity":0.25,"execution":0.25,"ambiguity":0.25,"business_fit":0.25},
    "tta_text_s": 60,
    "tta_sop_s": 300
  },
  "tests": [
    {
      "id":"T1",
      "name":"Spec complet",
      "input":{"custom":{"goal":"CreÈ™tere MQL +30%","audience":"B2B","constraints":[],"time_horizon":"90d"}},
      "assert":{"schema_ok":True,"output_spec_complete":True,"kpi_min":80,"no_promises":True,"facts_grounded":True,"contains":["Opportunity","RICE"]}
    }
  ],
  "guardrails": {
    "no_promises": True,
    "no_unfounded_claims": True,
    "privacy_safe": True,
    "confidentiality": True,
    "respect_style": True,
    "style_rules": ["clar, fÄƒrÄƒ superlative absolute", "ton strategic, nonâ€‘vÃ¢nzare"]
  },
  "deps": [],
  "evaluation_hooks": ["clarity","execution","ambiguity","business_fit"],
  "telemetry_keys": ["run_id","model","tokens_in","tokens_out","scores","policy_hits"]
}

# Write files
schema_path = "/mnt/data/module.spec.schema.json"
spec_path = "/mnt/data/module.spec.json"

with open(schema_path, "w", encoding="utf-8") as f:
    json.dump(schema, f, ensure_ascii=False, indent=2)
with open(spec_path, "w", encoding="utf-8") as f:
    json.dump(module_spec, f, ensure_ascii=False, indent=2)

(schema_path, spec_path)







# Build a copy-ready prompt.json (run config) + its JSON Schema validator.
# Files produced:
#  - /mnt/data/prompt.run.schema.json
#  - /mnt/data/prompt.json
#  - /mnt/data/prompt.chained.json (example when chaining from a previous run)
import json, uuid, datetime

NOW = datetime.datetime(2025,8,18,12,0,0)

schema = {
  "$id": "https://promptforge.v3/schemas/prompt.run.schema.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "PROMPTFORGE v3 â€” prompt.json (Run Config)",
  "type": "object",
  "additionalProperties": False,
  "required": ["project","run_id","module","sevenD","entitlements","telemetry"],
  "properties": {
    "project": {"type":"string","pattern":"^[A-Z0-9_\\-\\.]{3,64}$"},
    "run_id": {"type":"string","minLength":8,"maxLength":64},
    "timestamp": {"type":"string","format":"date-time"},
    "actor": {
      "type":"object","additionalProperties": False,
      "properties": {
        "user_id":{"type":"string"},
        "org_id":{"type":"string"},
        "email":{"type":"string","format":"email"},
        "role":{"type":"string","enum":["owner","admin","editor","viewer"]}
      }
    },
    "module": {
      "type":"object","additionalProperties": False,
      "required":["code"],
      "properties": {
        "code":{"type":"string","pattern":"^M\\d{2}$"},
        "semver":{"type":"string","pattern":"^\\d+\\.\\d+\\.\\d+$"},
        "pin_semver":{"type":"boolean","default": False}
      }
    },
    "sevenD": {
      "type":"object","additionalProperties": False,
      "required":["domain","output"],
      "properties": {
        "domain":{"type":"string"},
        "scale":{"type":"string"},
        "urgency":{"type":"string"},
        "complexity":{"type":"string"},
        "resources":{"type":"string"},
        "application":{"type":"string"},
        "output":{"type":"string"},
        "diversity_budget":{"type":"number","minimum":0,"maximum":1,"default":0.2},
        "requested":{"type":"object"},              
        "final":{"type":"object"},                  
        "signature":{"type":"string","minLength":4} 
      }
    },
    "inputs": {
      "type":"object","additionalProperties": True,
      "description":"Params custom pentru modul; validarea se face cu module.spec.schema.json > inputs.schema."
    },
    "deps": {   # opÈ›ional, pentru chain
      "type":"array",
      "items": {
        "type":"object","additionalProperties": False,
        "required":["from_run_id","module_code","signature_7d"],
        "properties": {
          "from_run_id":{"type":"string"},
          "module_code":{"type":"string","pattern":"^M\\d{2}$"},
          "artifact_ref":{"type":"string","description":"Ex: path relativ Ã®n bundle sau cheie logicÄƒ"},
          "signature_7d":{"type":"string"}
        }
      }
    },
    "entitlements": {
      "type":"object","additionalProperties": False,
      "required":["plan"],
      "properties": {
        "plan":{"type":"string","enum":["Pilot","Pro","Enterprise"]},
        "features":{"type":"array","items":{"type":"string"}},
        "industry_keys":{"type":"array","items":{"type":"string"}},
        "limits":{"type":"object","additionalProperties": True}
      }
    },
    "export": {
      "type":"object","additionalProperties": False,
      "properties": {
        "requested_files":{"type":"array","items":{"type":"string","enum":["txt","md","pdf","json"]}},
        "visibility":{"type":"string","enum":["internal","public"],"default":"internal"}
      }
    },
    "guardrails": {
      "type":"object","additionalProperties": False,
      "properties": {
        "no_promises":{"type":"boolean","default": True},
        "no_unfounded_claims":{"type":"boolean","default": True},
        "confidentiality":{"type":"boolean","default": True}
      }
    },
    "telemetry": {
      "type":"object","additionalProperties": False,
      "required":["tta_seconds","score"],
      "properties": {
        "tta_seconds":{"type":"integer","minimum":0},
        "score":{"type":"integer","minimum":0,"maximum":100},
        "tokens_in":{"type":"integer","minimum":0},
        "tokens_out":{"type":"integer","minimum":0},
        "model":{"type":"string"},
        "ruleset_version":{"type":"string"},
        "policy_hits":{"type":"array","items":{"type":"string"}}
      }
    }
  }
}

prompt = {
  "project": "PROMPTFORGE_v3",
  "run_id": "2025-08-18_MKT_M07_0001",
  "timestamp": NOW.isoformat()+"Z",
  "actor": {"user_id":"u_123","org_id":"org_456","email":"ops@example.com","role":"editor"},
  "module": {"code":"M07","semver":"0.1.0","pin_semver": True},
  "sevenD": {
    "domain":"MKT","scale":"team","urgency":"normal","complexity":"medium","resources":"standard","application":"content_ops","output":"bundle",
    "diversity_budget": 0.2,
    "requested": {"domain":"MKT","output":"bundle"},
    "final": {"domain":"MKT","scale":"team","urgency":"normal","complexity":"medium","resources":"standard","application":"content_ops","output":"bundle"},
    "signature": "MKT-team-content_ops-bundle"
  },
  "inputs": {"goal":"CreÈ™tere MQL +30%","audience":"B2B","constraints":[],"time_horizon":"90d"},
  "deps": [],
  "entitlements": {"plan":"Pro","features":["txt","md","pdf","cloud_history"],"industry_keys":["MKT"],"limits":{"runs_per_day":100}},
  "export": {"requested_files":["txt","md","pdf"],"visibility":"internal"},
  "guardrails": {"no_promises": True, "no_unfounded_claims": True, "confidentiality": True},
  "telemetry": {"tta_seconds": 42, "score": 86, "tokens_in": 2100, "tokens_out": 1400, "model":"gpt-5o", "ruleset_version":"0.1.0", "policy_hits":[]}
}

prompt_chained = {
  **{k:v for k,v in prompt.items() if k not in ("run_id","module","sevenD","deps")},
  "run_id": "2025-08-18_MKT_M14_0002",
  "module": {"code":"M14","semver":"0.1.0","pin_semver": True},
  "sevenD": {
    "domain":"MKT","scale":"team","urgency":"normal","complexity":"medium","resources":"standard",
    "application":"content_ops","output":"bundle","diversity_budget":0.15,
    "requested":{"domain":"MKT","output":"bundle"},
    "final":{"domain":"MKT","scale":"team","urgency":"normal","complexity":"medium","resources":"standard","application":"content_ops","output":"bundle"},
    "signature":"MKT-team-content_ops-bundle"
  },
  "deps": [
    {"from_run_id":"2025-08-18_MKT_M07_0001","module_code":"M07","artifact_ref":"prompt.md","signature_7d":"MKT-team-content_ops-bundle"}
  ]
}

with open("/mnt/data/prompt.run.schema.json","w",encoding="utf-8") as f:
  json.dump(schema, f, ensure_ascii=False, indent=2)

with open("/mnt/data/prompt.json","w",encoding="utf-8") as f:
  json.dump(prompt, f, ensure_ascii=False, indent=2)

with open("/mnt/data/prompt.chained.json","w",encoding="utf-8") as f:
  json.dump(prompt_chained, f, ensure_ascii=False, indent=2)

("/mnt/data/prompt.run.schema.json","/mnt/data/prompt.json","/mnt/data/prompt.chained.json")





Ce conÈ›ine È™i cum Ã®l foloseÈ™ti (rezumat scurt)

project, run_id, timestamp, actor â€“ identificare È™i audit.

module â€“ code + semver (poÈ›i forÈ›a pin cu pin_semver:true).

sevenD â€“ include requested vs final + signature (compatibilitate Mnâ†’Mn+1).

inputs â€“ parametrii custom validaÈ›i de module.spec.schema.json.

deps â€“ pentru chain: referinÈ›e la run_id anterior + signature_7d identicÄƒ.

entitlements â€“ snapshot plan/feature/keys/limits (gating UI+API).

export â€“ ce fiÈ™iere vrei (txt|md|pdf|json) È™i visibility (internal|public).

guardrails â€“ toggles de siguranÈ›Äƒ (promises/claims/confidentiality).

telemetry â€“ tta_seconds, score, tokens, model, ruleset_version, policy_hits.









import json
from pathlib import Path
from datetime import datetime

# schema oficiala pt export.manifest.json
schema = {
    "$schema": "http://json-schema.org/draft-07/schema#",
    "title": "ExportManifest",
    "type": "object",
    "required": [
        "project", "module", "run_id", "sevenD",
        "files", "score", "kpi", "license_notice", "created_at"
    ],
    "properties": {
        "project": {"type": "string"},
        "module": {"type": "string"},
        "run_id": {"type": "string"},
        "sevenD": {
            "type": "object",
            "properties": {
                "domain": {"type": "string"},
                "scale": {"type": "string"},
                "urgency": {"type": "string"},
                "complexity": {"type": "string"},
                "resources": {"type": "string"},
                "application": {"type": "string"},
                "output": {"type": "string"}
            },
            "required": ["domain","scale","urgency","complexity","resources","application","output"]
        },
        "files": {
            "type": "object",
            "patternProperties": {
                ".*": {"type": "string"}  # sha256 hash
            }
        },
        "score": {"type": "integer", "minimum": 0, "maximum": 100},
        "kpi": {"type": "object"},
        "license_notice": {"type": "string"},
        "bundle_checksum": {"type": "string"},
        "path_prefix": {"type": "string"},
        "visibility": {"type": "string", "enum": ["internal","public"]},
        "dlp_summary": {"type": "string"},
        "created_at": {"type": "string", "format": "date-time"}
    }
}

# manifest exemplu
manifest = {
    "project": "PROMPTFORGE_v3",
    "module": "M07",
    "run_id": "2025-08-18_MKT_M07_0001",
    "sevenD": {
        "domain": "MKT",
        "scale": "team",
        "urgency": "normal",
        "complexity": "medium",
        "resources": "standard",
        "application": "content_ops",
        "output": "bundle"
    },
    "files": {
        "prompt.txt": "sha256:111aaa...",
        "prompt.json": "sha256:222bbb...",
        "prompt.md": "sha256:333ccc...",
        "prompt.pdf": "sha256:444ddd...",
        "manifest.json": "sha256:555eee..."
    },
    "score": 86,
    "kpi": {"tta_text_s": 42, "tta_sop_s": 230},
    "license_notice": "PFv3 Pro - Marketing",
    "bundle_checksum": "sha256:999zzz...",
    "path_prefix": "/bundles/PROMPTFORGE_v3/2025-08-18/MKT/M07/run_0001/",
    "visibility": "internal",
    "dlp_summary": "no PII, safe_to_use knowledge only",
    "created_at": datetime(2025,8,18,0,0,0).isoformat()+"Z"
}

# write files
schema_path = Path("/mnt/data/export.manifest.schema.json")
manifest_path = Path("/mnt/data/export.manifest.json")

schema_path.write_text(json.dumps(schema, indent=2))
manifest_path.write_text(json.dumps(manifest, indent=2))

str(schema_path), str(manifest_path)






StructurÄƒ explicatÄƒ
CÃ¢mpuri obligatorii

project â€“ codul proiectului (ex. PROMPTFORGE_v3)

module â€“ modulul care a generat bundle-ul (ex. M07)

run_id â€“ identificator unic al rularii

sevenD â€“ snapshot complet al parametrilor 7D (domain, scale, urgency, complexity, resources, application, output)

files â€“ map [nume_fiÈ™ier â†’ sha256]

score â€“ scor total obÈ›inut la evaluare

kpi â€“ metrici suplimentare (TTA text, TTA sop etc.)

license_notice â€“ string de licenÈ›Äƒ inserat obligatoriu

created_at â€“ timestamp ISO-8601

CÃ¢mpuri suplimentare

bundle_checksum â€“ sha256 global pe Ã®ntreg bundle-ul

path_prefix â€“ cale de stocare /bundles/{project}/{date}/{domain}/{module}/{slug}/

visibility â€“ internal sau public (dupÄƒ export)

dlp_summary â€“ sumar al detecÈ›iilor DLP (ex. â€no PII, safe_to_use knowledge onlyâ€)

Exemplu livrat:

{
  "project": "PROMPTFORGE_v3",
  "module": "M07",
  "run_id": "2025-08-18_MKT_M07_0001",
  "sevenD": {
    "domain": "MKT",
    "scale": "team",
    "urgency": "normal",
    "complexity": "medium",
    "resources": "standard",
    "application": "content_ops",
    "output": "bundle"
  },
  "files": {
    "prompt.txt": "sha256:111aaa...",
    "prompt.json": "sha256:222bbb...",
    "prompt.md": "sha256:333ccc...",
    "prompt.pdf": "sha256:444ddd...",
    "manifest.json": "sha256:555eee..."
  },
  "score": 86,
  "kpi": { "tta_text_s": 42, "tta_sop_s": 230 },
  "license_notice": "PFv3 Pro - Marketing",
  "bundle_checksum": "sha256:999zzz...",
  "path_prefix": "/bundles/PROMPTFORGE_v3/2025-08-18/MKT/M07/run_0001/",
  "visibility": "internal",
  "dlp_summary": "no PII, safe_to_use knowledge only",
  "created_at": "2025-08-18T00:00:00Z"
}





Mai jos ai ruleset.yml â€œnucleuâ€ (gata de lipit). ConÈ›ine: enum-urile 7D, defaults per domeniu, standardul de prompt, rubricÄƒ de test, export + checksum, entitlements È™i SLO/telemetrie. Serverul Ã®l Ã®ncarcÄƒ la boot; UI-ul nu are voie sÄƒ-l modifice (doar citeÈ™te).

# PROMPTFORGE v3 â€” ruleset.yml (SSOT)
project: PROMPTFORGE_v3
schema_version: 1
semver: 0.1.0
is_ssot: true
description: >
  Single Source of Truth. GuverneazÄƒ modulele, 7D, test, export, entitlements.
  UI nu poate scrie aici; orice override se respinge È™i se logheazÄƒ.

policies:
  defaults_editable_only_here: true
  ui_cannot_override_defaults: true
  compatibility:
    signature_fields: [domain, scale, urgency, complexity, resources, application, output_format]
  security:
    knowledge_scoping_tag: safe_to_use
    pii_public_export: anonymize
  telemetry:
    do_not_log_raw_client_content: true

sevenD:
  required: [domain, output_format]
  enums:
    domain: [saas, fintech, ecommerce, consulting, education, healthcare, legal, marketing, media, real_estate, hr, ngo, government, web3, aiml, cybersecurity, manufacturing, logistics, travel, gaming, fashion, beauty, spiritual, architecture, agriculture]
    scale: [personal_brand, solo, startup, boutique_agency, smb, corporate, enterprise]
    urgency: [low, planned, sprint, pilot, crisis]
    complexity: [foundational, standard, advanced, expert]
    resources: [minimal, solo, lean_team, agency_stack, full_stack_org, enterprise_budget]
    application: [training, audit, implementation, strategy_design, crisis_response, experimentation, documentation]
    output_format: [txt, md, checklist, spec, playbook, json, yaml, diagram, bundle]
  aliases:
    scale: { program: org, department: org }
    output_format: { document: md, pack: bundle }
  validation:
    enum_only: true
    raise_on_invalid: true
  fallback:
    by_domain_defaults: true
  variability:
    diversity_budget:
      applies_to: [style, angle]
      not_applied_to: [facts]
      range: { min: 0.0, max: 1.0 }
      default: 0.2

defaults_template: &defaults_base
  scale: startup
  urgency: planned
  complexity: standard
  resources: lean_team
  application: implementation
  output_format: spec

domains:
  saas:
    <<: *defaults_base
    output_format: spec
  fintech:
    scale: enterprise
    urgency: sprint
    complexity: advanced
    resources: full_stack_org
    application: implementation
    output_format: spec
  ecommerce:
    scale: smb
    urgency: sprint
    complexity: standard
    resources: agency_stack
    application: implementation
    output_format: playbook
  education:
    scale: smb
    urgency: planned
    complexity: standard
    resources: lean_team
    application: training
    output_format: playbook
  healthcare:
    scale: corporate
    urgency: crisis
    complexity: expert
    resources: full_stack_org
    application: implementation
    output_format: spec
  # â€¦ completezi restul domeniilor dupÄƒ nomenclatorul CORE 25

prompt_standard:
  sections: [ROLE_GOAL, CONTEXT_7D, OUTPUT_SPEC, PROCESS, GUARDRAILS, EVALUATION_HOOKS, TELEMETRY_KEYS]
  non_deletable_in_ui: true
  output_spec_contract:
    must_define_fields: [format, fields, example]
    example_minimal:
      format: markdown
      fields: [title, sections, kpi]
      example: |
        # Titlu
        - SecÈ›iune 1
        - SecÈ›iune 2
        KPI: {...}

test:
  rubric: [clarity, execution, ambiguity, business_fit]
  threshold: 80
  auto_fix:
    enabled: true
    max_iterations: 1

export:
  structure: standard_bundle
  bundle_path_template: "/bundles/{project}/{date}/{domain}/{module}/{slug}/"
  artifacts: ["prompt.txt","prompt.json","prompt.md","prompt.pdf","telemetry.json","manifest.json","checksum.sha256"]
  checksum:
    algo: sha256
    include: ["prompt.txt","prompt.json","prompt.md","prompt.pdf","manifest.json"]

entitlements:
  plans:
    Pilot:
      modules: "M01-M10"
      features: ["txt","md"]
      limits: { runs_per_day: 20 }
    Pro:
      modules: "M01-M30"
      features: ["txt","md","pdf","json","cloud_history","gpt_test_live","evaluator_ai"]
      limits: { runs_per_day: 100 }
    Enterprise:
      modules: "M01-M50"
      features: ["api","bundle_zip","white_label","seats","multi_industry","cloud_history","gpt_test_live","evaluator_ai"]
      limits: { runs_per_day: 1000 }
  gating:
    hide_modules_without_entitlement: true
    block_endpoints_without_entitlement: true

telemetry:
  keys: [run_id, started_at, finished_at, tta_seconds, score_total, model, tokens_in, tokens_out, domain, module, plan, policy_hits, ruleset_version]
  slo:
    tta_text_seconds_p95: 60
    tta_sop_seconds_p95: 300
    pass_rate_pct_min: 99

versioning:
  store: supabase
  tables: [projects, modules, runs, bundles, entitlements, plans, domain_configs]
  migrations:
    semver_major_requires_compat_script: true
  change_policies:
    defaults_only_editable_here: true
    log_every_override: true

license:
  manifest_required_field: license_notice
  default_notice:
    Pilot: "PFv3 Pilot"
    Pro: "PFv3 Pro"
    Enterprise: "PFv3 Enterprise"

signatures:
  engine7d_signature_sha256: "domain|scale|urgency|complexity|resources|application|output_format"
  chain_compat_required: true  # Mâ‚™ â†’ Mâ‚™â‚Šâ‚ doar dacÄƒ semnÄƒtura 7D coincide

ready_done:
  DoR:
    required: [sevenD_valid, entitlement_valid, output_spec_loaded, tests_defined, input_minimum]
  DoD:
    required: [score_gte_80, output_complete, checksum_valid, manifest_written, telemetry_saved]


Note de implementare (server):

Ãncarci ruleset.yml la boot; toate cererile normalizeazÄƒ 7D cu defaults per domeniu; UI-ul nu poate rescrie defaults.

Standardul de prompt + rubricÄƒ È™i pragurile de trecere sunt identice cu ce-am definit Ã®n Test Engine (PASS la â‰¥80, o singurÄƒ iteraÈ›ie â€œtightenâ€).

Exportul e bundle cu .txt/.md/.json/.pdf + manifest + checksum sha256; PDF/JSON/ZIP se deschid doar pe Pro/Enterprise conform entitlements.

Entitlements sunt featureâ€‘flags binare (ex: canExportPDF, canUseGptTestReal, hasAPI, canExportBundleZip) derivate din plan È™i packâ€‘uri; gating Ã®n UI/API la fiecare acÈ›iune.

Nomenclatorul CORE 25 + defaults 7D guverneazÄƒ tonul, KPI-urile È™i compliance per domeniu; SSOT mapeazÄƒ direct aceste preseturi.







Standardul de execuÈ›ie pentru PROMPTFORGEâ„¢, conform blueprint-urilor din knowledge:

ğŸ“¦ Standardul de ExecuÈ›ie â€” 4 artefacte per run

Fiecare rulare validÄƒ (run) produce un bundle determinist de 4 artefacte canonice:

1. prompt.txt â€” Artefact brut

Text simplu, UTF-8 LF.

Include secÈ›iunile standard (fixe, non-deletable):

ROLE & GOAL

CONTEXT & 7D (snapshot complet, validat enum-only)

OUTPUT SPEC (format + cÃ¢mpuri)

PROCESS (paÈ™i operaÈ›ionali)

GUARDRAILS (interdicÈ›ii + fallback)

EVALUATION HOOKS (criterii scorabile)

TELEMETRY KEYS (metadate colectate)

FÄƒrÄƒ PII sau client_raw Ã®n clar â†’ dacÄƒ existÄƒ â†’ [REDACTED].

Determinist: aceeaÈ™i rulare â†’ acelaÈ™i conÈ›inut.

2. prompt.json â€” Config + metadate

JSON ordonat alfabetic (determinism).

StructurÄƒ minimÄƒ:

{
  "project": "PROMPTFORGE_v3",
  "module": "M07",
  "semver": "1.2.0",
  "run_id": "uuid",
  "final_7d": {
    "domain": "fintech",
    "scale": "enterprise",
    "urgency": "sprint",
    "complexity": "advanced",
    "resources": "full_stack_org",
    "application": "implementation",
    "output_format": "spec"
  },
  "custom_inputs": {...},
  "output_spec": {...},
  "score": 86,
  "telemetry": {
    "model": "gpt-4o",
    "tokens_in": 521,
    "tokens_out": 1887,
    "cost_usd": 0.34,
    "tta_seconds": 42,
    "policy_hits": []
  }
}


Include overrides faÈ›Äƒ de defaults din ruleset.yml.

Nu logheazÄƒ conÈ›inut brut, doar hash + difuri.

3. prompt.md â€” Raport lizibil

Markdown lizibil, mapat 1:1 pe OUTPUT SPEC.

Include:

Rezumat (titlu, scop, data, modul)

Config 7D + context de industrie (jargon, compliance, KPI)

Obiectiv + KPI target

Proces detaliat (paÈ™i + fallback)

Excerpt din prompt.txt (primele 10 linii)

Util pentru: prezentÄƒri, colaborare, documentare.

4. prompt.pdf â€” Export comercial

Randat din prompt.md cu CSS standard.

SetÄƒri implicite: A4, margini 16mm, header {project} Â· {domain} Â· {M##}, footer {run_id} Â· page #.

Fonturi embed, fÄƒrÄƒ metadate dinamice (normalizezi /CreationDate).

Include watermark Ã®n footer: â€Confidential Â· {org} Â· {run_id}â€.

Se livreazÄƒ doar pe planuri Pro/Enterprise (gating prin entitlements).

ğŸ” Manifest & Checksum

Fiecare bundle are adiÈ›ional:

manifest.json â€” metadate: project, run_id, 7D, scoruri, KPI breakdown, entitlements, license_notice.

checksum.sha256 â€” hash canonic pe cele 5 fiÈ™iere (exclus checksum Ã®nsuÈ™i).

bundle_checksum â€” SHA-256 concatenat determinist.

ğŸ“ˆ Reguli de Gating (Entitlements)

Pilot: doar .txt, .md.

Pro: .txt, .md, .json, .pdf.

Enterprise: toate + API + multi-industry.
â†’ UI ascunde opÈ›iunile nepermise, API blocheazÄƒ dacÄƒ se forÈ›eazÄƒ.

âœ… InvarianÈ›i

Nicio rulare fÄƒrÄƒ 7D valid È™i complet.

Niciun bundle fÄƒrÄƒ manifest + checksum.

Score <80 â‡’ tighten-once â†’ reevaluezi. DacÄƒ rÄƒmÃ¢ne <80 â‡’ FAIL (nu exportezi bundle).

Nicio abatere de la structura ruleset.yml â†’ 409 RULESET_CONFLICT.

Toate exporturile sunt deterministe È™i verificabile cu shasum -a 256.








KPIâ€‘urile dure ca â€œcontracte operaÈ›ionaleâ€ (definiÈ›ie, cum mÄƒsori, alerte, remediere, teste de acceptanÈ›Äƒ). Sunt aliniate cu DoR/DoD, Evaluator, Export & Checksum, Entitlements È™i fluxul Stripeâ†’Supabase.

0) GuvernanÈ›Äƒ & date

Sursa de adevÄƒr pentru scoruri/telemetrie: tabelele runs, prompt_scores/eval_scores, bundles; nu salvezi conÈ›inut brut, doar hash/difuri È™i scoruri. Telemetria include: run_id, model, tokens, duration, cost_usd, policy_hits.

Gate unic de calitate: Score total â‰¥ 80; sub prag rulezi o singurÄƒ iteraÈ›ie tightenâ€‘once; dacÄƒ rÄƒmÃ¢ne <80 â‡’ FAIL (nu livrezi bundle).

1) TTA text < 60s

DefiniÈ›ie. Timeâ€‘Toâ€‘Artifact (text): durata dintre started_at È™i finished_at pentru rulari simple (artefact text/MD), p95 â‰¤ 60s; alertÄƒ dacÄƒ p95 depÄƒÈ™eÈ™te 60s.

MÄƒsurare (SQL).

select run_id,
       extract(epoch from (finished_at - started_at)) as tta_seconds
from runs
where created_at >= now() - interval '1 day';


Agregat 7 zile (p95, passâ€‘rate, outliers):

select
  percentile_cont(0.95) within group (order by (finished_at - started_at)) as p95_tta,
  count(*) filter (where status='success') * 100.0 / count(*) as pass_rate_pct
from runs
where created_at >= now() - interval '7 days';


Alerte.

p95 TTA > 60s â‡’ â€œwarningâ€; p95 TTA > 120s â‡’ â€œcriticalâ€.

Remediere.

throttle pe rerolls, reducere tokens max, coadÄƒ prioritarÄƒ pentru Pro/Enterprise, retry cu backoff la model; log cost/run + model drift.

Test de acceptanÈ›Äƒ.

Scenariu 20 rulari â†’ p95 TTA â‰¤ 60s, fÄƒrÄƒ erori.

2) TTA SOP < 5m

DefiniÈ›ie. Timeâ€‘Toâ€‘Artifact pentru SOP/playbook/spec: p95 â‰¤ 300s; se aplicÄƒ bundle pipeline (MD/JSON/PDF).

MÄƒsurare. Identic cu #1, filtrat pe rulari care produc bundle (MD/JSON/PDF).

Alerte.

p95 TTA SOP > 300s â‡’ â€œwarningâ€; > 420s â‡’ â€œcriticalâ€.

Remediere.

Paging pentru generator PDF; preâ€‘randare È™abloane; task queue separatÄƒ pentru PDF; verificare entitlements Ã®nainte de export.

Test de acceptanÈ›Äƒ.

10 bundleâ€‘uri consecutive â†’ toate finalizeazÄƒ sub 300s È™i exportul trece checksum.

3) Score AI â‰¥ 80/100

DefiniÈ›ie & rubricÄƒ. Evaluatorul noteazÄƒ: Claritate, ExecuÈ›ie, Ambiguitate (invers), Businessâ€‘Fit (0â€“100 fiecare). PASS dacÄƒ: Claritate â‰¥80 âˆ§ ExecuÈ›ie â‰¥80 âˆ§ Ambiguitate â‰¤20 âˆ§ Businessâ€‘Fit â‰¥75. Sub 80: tightenâ€‘once; dacÄƒ tot <80 â†’ FAIL (nu exporÈ›i).

Flux. generate â†’ evaluate â†’ (opÈ›ional) tightenâ€‘once â†’ reâ€‘evaluate â†’ gate â†’ export.

Telemetrie. PersistÄƒ breakdownul pe axe + incidents (promises/ungrounded/confidentiality).

Test de acceptanÈ›Äƒ.

Prompt cu hedging + Ã®ntrebÄƒri: Ã®nainte <80; dupÄƒ tighten â‰¥80; altfel FAIL.

4) Export bundle + checksum (obligatoriu)

ConÈ›inut minim bundle.

prompt.txt, prompt.md, prompt.json, prompt.pdf (Pro/Ent), manifest.json, checksum.sha256 (ordine canonicÄƒ), + telemetry.json (opÈ›ional).

Manifest & checksum.

manifest.json conÈ›ine: run_id, final_7d, scoruri, entitlements, license_notice, file_hashes, bundle_checksum (SHAâ€‘256 pe concatenarea hashâ€‘urilor per fiÈ™ier Ã®n ordine canonicÄƒ). Verificare cu shasum -a 256.

Gating.

Pilot: .txt/.md; Pro: .pdf/.json permise; Enterprise: + .bundle.zip complet; UI ascunde, API blocheazÄƒ contrar entitlements.

Zero leak PII.

DLP: dacÄƒ PII detectat â‡’ blocare export public + incident security. KPI â€œzero leak PIIâ€ = 100%.

Test de acceptanÈ›Äƒ.

Export Pro md+json+pdf: manifest OK, checksum consistent; Enterprise: bundle.zip + checksum BUNDLE OK.

5) Stripe + Supabase live (billing & entitlements)

Obiectiv. Stripe este sursa evenimentelor (plan/addâ€‘on/pack), Supabase stocheazÄƒ subscriptions, plans, entitlements. Entitlements efective = PLAN âŠ• ADDONS âŠ• PACKS âŠ• LICENSE; se verificÄƒ serverâ€‘side la run/export/API.

Flux webhook (idempotent).
checkout.session.completed / customer.subscription.* â†’ upsert subscription (plan, seats, trial_end) â†’ calculezi flags (canExportPDF/JSON, gptTestReal, cloudHistory, API, WhiteLabel, BundleZip etc.) â†’ entitlements (orgâ€‘wide/perâ€‘user) actualizate.

Model & RLS.
Tabele: plans, subscriptions, entitlements, orgs, org_members; RLS pe org_id; vederi entitlements_effective, org_plan_snapshot.

Test de acceptanÈ›Äƒ.

Upgrade Creatorâ†’Pro: canExportPDF/JSON=true, hasCloudHistory=true.

Downgrade Proâ†’Creator: export PDF/JSON blocat (403) + paywall.

6) 3 SKU: Pilot / Pro / Enterprise

Matrice minimÄƒ (gating funcÈ›ional).

Pilot: M01â€“M10, export .txt/.md, fÄƒrÄƒ cloud; doar test simulat.

Pro: M01â€“M30, export .pdf/.json, Test Engine live, Cloud History, Evaluator AI.

Enterprise: M01â€“M50, + API, Whiteâ€‘label, seats, .bundle.zip.
Gating se aplicÄƒ Ã®n UI È™i Ã®n /api/run|/api/export; ascunzi controalele nepermise, blochezi Ã®n BE.

Paywall â€œmomente ahaâ€.

â€œRun GPT Test (real)â€ (Creatorâ†’Pro), â€œExport .pdf/.jsonâ€ (Creatorâ†’Pro), â€œAPI/Whiteâ€‘label/Bundleâ€ (Proâ†’Enterprise).

7) Dashboard & Alarme (sÄƒptÄƒmÃ¢nal/zilnic)

KPIs zilnice. TTA, score_total, export_ok, zero_leak, cost/run. Query exemplu È™i alarme p95 deja definite (vezi Â§1â€“2).

SLA agregat (7 zile).

select
  count(*) filter (where status='success')*100.0/count(*) as pass_rate_pct,
  percentile_cont(0.95) within group (order by score_total) as p95_score,
  percentile_cont(0.95) within group (order by (finished_at - started_at)) as p95_tta
from runs
where created_at >= now() - interval '7 days';


PASS rate â‰¥ 99%, p95_TTA_text â‰¤ 60s, p95_TTA_SOP â‰¤ 300s, p95_score â‰¥ 80. Alerte automate pe breÈ™e.

8) DoR/DoD automatizate (gate final)

DoR: 7D valid (enumâ€‘only), entitlement valid, output_spec Ã®ncÄƒrcat, tests definite, input minim existent. FÄƒrÄƒ DoR â‡’ nu rulezi.

DoD: Score â‰¥80, output complet, checksum valid, manifest existent (cu license_notice), telemetrie salvatÄƒ. FÄƒrÄƒ DoD â‡’ nu livrezi bundle.

9) Teste E2E obligatorii

/run â†’ PASS â†’ export: primeÈ™ti bundle cu manifest+checksum OK (Pro/Enterprise).

/run â†’ FAIL (score <80 dupÄƒ tighten): rÄƒspuns 422, fÄƒrÄƒ bundle.

Gating: Creator Ã®ncearcÄƒ export PDF â†’ 403 + paywall.

Webhook Stripe: upgrade Pro seteazÄƒ flags Ã®n entitlements; downgrade inverseazÄƒ.

Rezumat â€œgata de implementareâ€

TTA text: p95 â‰¤ 60s; TTA SOP: p95 â‰¤ 300s. MÄƒsori din runs.*.

Score AI: PASS dacÄƒ toate pragurile rubricii sunt atinse; tightenâ€‘once; altfel FAIL.

Export bundle + checksum: artefacte canonice + manifest + SHAâ€‘256 determinist, gating per plan.

Stripe+Supabase live: webhookuri â†’ entitlements efective; gating UI/API.

3 SKU: Pilot / Pro / Enterprise cu matrice clarÄƒ de capabilitÄƒÈ›i.







Versionarea Ã®n PROMPTFORGEâ„¢ o legi de 4 chei: semver (al modulului), run_id (UUID per execuÈ›ie), domain_code (din SSOT 7D) È™i M## (ID modul). Mai jos ai specificaÈ›ia completÄƒ (naming, DB, API, reguli de incrementare, compat, exemple), aliniatÄƒ la SSOT/rulebook, 7Dâ€‘signature, DoR/DoD È™i bundle manifest.

1) Identificatori canonici

module_semver (ex. 1.2.3) â€” versiunea contractului modulului (schema de input/output/KPI/guardrails). Major bump cere script de compatibilitate; minor = aditivi; patch = fixuri fÄƒrÄƒ impact de contract.

run_id â€” UUID v4 unic per rulare; apare Ã®n telemetrie È™i manifest/export.

domain_code â€” cod 7D din SSOT (ex. FIN, SAAS, EDU, â€¦) conform enumerÄƒrilor domain din ruleset.yml (CORE 25 detaliat Ã®n framework).

module_code â€” M## (ex. M07) â€“ identificatorul modulului.

Invariant: SSOT (ruleset.yml) guverneazÄƒ enumâ€‘urile 7D, pragurile de evaluare È™i politicile de versionare; UI nu poate rescrie defaults.

2) Stringuri compuse & naming
2.1. Cheia logicÄƒ de run (afiÈ™atÄƒ Ã®n UI, loguri)
PFv3/{domain_code}/{module_code}@{module_semver}#{run_id_short}
ex: PFv3/FIN/M07@1.2.3#C39F2A


run_id_short = primele 6â€“8 caractere din UUID pentru lizibilitate.

Se pÄƒstreazÄƒ run_id complet Ã®n DB/manifest.

2.2. CÄƒi & fiÈ™iere (compat cu spec)

Path standard bundle (nemodificat):
/bundles/{project}/{date}/{domain}/{module}/{slug}/

Numele arhivei rÄƒmÃ¢ne compat:
bundle-{module_code}-{run_hash}.zip

Versionarea intrÄƒ Ã®n manifest (module_semver, ruleset_version) È™i Ã®n DB (coloane dedicate), nu Ã®n numele fiÈ™ierului â†’ zero breakage.

3) Model de date (Supabase/Postgres)
3.1. Tabele & cÃ¢mpuri cheie

modules: module_code text PK, semver text, output_schema jsonb, â€¦

module_versions: istoric semver per modul (contract complet)

runs:

id uuid PK (run_id)

module_code text, module_semver text

final_7d jsonb, signature_7d text, status, scores jsonb, score_total int

telemetry jsonb (model, tokens, cost, overrides, ruleset_version)

bundles:

id uuid PK, run_id uuid FK, formats text[], paths jsonb,

checksum text, version text (semver exporter / bundle schema), exported_at timestamptz.

RelaÈ›ii È™i RLS multiâ€‘tenant: vezi schema canonicÄƒ (orgs, org_members, runs, bundles, entitlements).
signature_7d = sha256(domain|scale|urgency|complexity|resources|application|output_format) â€“ asigurÄƒ compatibilitatea chain Mâ‚™â†’Mâ‚™â‚Šâ‚.

3.2. ConstrÃ¢ngeri utile
alter table runs add constraint runs_semver_chk
  check (module_semver ~ '^[0-9]+\.[0-9]+\.[0-9]+$');

create index runs_signature_idx on runs(signature_7d);
create index bundles_run_idx on bundles(run_id);


(performanÈ›Äƒ pe cÄƒutare dupÄƒ 7D/semver È™i join rapid runâ†’bundle).

4) Manifest & telemetrie (export)

manifest.json conÈ›ine obligatoriu:
run_id, module_id, final_7d, score, file_hashes, bundle_checksum, version (semver manifest/exporter), license_notice, plus parameter_set_7d/telemetry; totul verificabil prin SHAâ€‘256 canonic.
Telemetria nu pÄƒstreazÄƒ conÈ›inut client brut; doar scoruri/hashuri/overrides.

5) API & contracte

POST /api/run/{module} â†’ normalizeazÄƒ 7D (enumâ€‘only) cu SSOT, verificÄƒ entitlements, ruleazÄƒ, evalueazÄƒ, exportÄƒ; rÄƒspunsul include:
run_id, module_code, module_semver, domain_code (din 7D), score_total, bundle.links[].

GET /api/runs/{id}, GET /api/bundles/{id} â†’ expun manifestul + linkuri, respectÃ¢nd gating pe planuri (PDF/JSON/ZIP).

6) Reguli SemVer (modul) â€” cÃ¢nd creÈ™ti versiunea

MAJOR (X.0.0): schimbi schema output (cÃ¢mpuri obligatorii/format), enumâ€‘uri 7D acceptate sau semnÄƒtura de evaluare â‡’ ceri script de compatibilitate; blochezi chain dacÄƒ signature_7d nu mai corespunde.

MINOR (x.Y.0): adaugi cÃ¢mpuri opÈ›ionale/metrici/KPI noi; output vechi rÄƒmÃ¢ne valid.

PATCH (x.y.Z): fixuri de text/guardrails/performanÈ›Äƒ fÄƒrÄƒ impact pe contract.

Invariant: ruleset_version (SSOT) este logatÄƒ Ã®n fiecare run; mismatch UIâ†”server â‡’ 409 RULESET_CONFLICT.

7) Compatibilitate interâ€‘modul (chain)

Rule: Mâ‚™ output â†’ Mâ‚™â‚Šâ‚ input doar dacÄƒ signature_7d_out(Mâ‚™) == signature_7d_in(Mâ‚™â‚Šâ‚); altfel 422 7D_SIGNATURE_MISMATCH cu diff (ex: output_format/spec vs playbook).

Semver & chain: dacÄƒ Mâ‚™ trece la MAJOR, livrezi compat script (mapare cÃ¢mpuri vechiâ†’noi sau mark [DEPRECATED]) È™i notezi Ã®n module_versions.

8) DoR/DoD & gates de calitate (legate de versiune)

DoR (Ready): 7D valid, entitlements OK, output_spec Ã®ncÄƒrcat, tests definite, input minim existent.

DoD (Done): Score â‰¥80, output complet, checksum valid, manifest scris, telemetrie salvatÄƒ â‡’ abia atunci bundleâ€‘ul este livrabil.

Evaluator & praguri (Claritate/ExecuÈ›ie/Ambiguitate/Businessâ€‘Fit) sunt standardizate; sub 80 rulezi tightenâ€‘once È™i reâ€‘evaluezi.

9) Exemple concrete
9.1. Un run Ã®n FinTech pe M07

Input: domain=fintech, output_format=spec â‡’ domain_code=FIN; module_code=M07; module_semver=1.2.3.

Cheie UI/log: PFv3/FIN/M07@1.2.3#8F2A6D.

Manifest (extract):

{
  "module_id": "M07",
  "version": "1.0.3",                // versiunea exporter/manifest schema
  "run_id": "a6b8e0aa-...-9c5f",
  "final_7d": {"domain":"fintech","output_format":"spec", "...": "..."},
  "score": 86,
  "file_hashes": {"prompt.txt":"sha256:..."},
  "bundle_checksum": "sha256:...",
  "license_notice": "PFv3 Pro",
  "telemetry": {"ruleset_version":"0.1.0","model":"gpt-4o","tokens_used":9132}
}


(Structura manifest & checksum conform specului de export).

9.2. SQL minim de persist (run + bundle)
insert into runs(id, org_id, module_code, module_semver, final_7d, signature_7d,
                 status, scores, score_total, telemetry, started_at, finished_at)
values (gen_random_uuid(), :org, 'M07', '1.2.3', :final_7d, :sig7d,
        'success', :scores, :total, :telemetry, now()-interval '8s', now());

insert into bundles(id, run_id, formats, paths, checksum, version, exported_at)
values (gen_random_uuid(), :run_id, '{md,json,pdf}', :paths, :sha, '1.0.3', now());

(Schema È™i relaÈ›iile sunt conforme cu modelul v1 stabil).

10) Politici de migrare & release
Release note per modul la fiecare MINOR/MAJOR (autoâ€‘generat pe baza diferenÈ›elor de contract) Ã®n module_versions.
Blocking gates: dacÄƒ lansezi MAJOR fÄƒrÄƒ compat script â†’ pipeline refuzÄƒ runâ€‘urile (semver_major_requires_compat_script: true).
Rollâ€‘forward sigur: filenameâ€‘urile bundle nu se schimbÄƒ; doar manifest/DB reflectÄƒ versiunile noi (compat indicat mai sus).

11) De ce aÈ™a (aliniere la standard)
SSOT & enums 7D Ã®n ruleset.yml, cu domain codes, SLO TTA, export & checksum, entitlements â€” rÄƒmÃ¢n sursa unicÄƒ de adevÄƒr.
Evaluator & gates asigurÄƒ Scoreâ‰¥80 Ã®nainte de livrare (tightenâ€‘once apoi FAIL).
Export are manifest + checksum canonice; PDF/JSON/ZIP sunt gated de plan (Pilot/Pro/Enterprise).
Chain se valideazÄƒ prin signature_7d, nu doar prin semver â€” zero ambiguitate interâ€‘modul.

Rezumat de implementare (toâ€‘do rapid)
AdaugÄƒ module_semver text Ã®n runs È™i version text Ã®n bundles (dacÄƒ nu existÄƒ).
Expune Ã®n /api/run â†’ { module_semver, run_id, domain_code }.
Scrie compatâ€‘script hook la MAJOR (semver_major_requires_compat_script=true).
AfiÈ™eazÄƒ Ã®n UI cheia scurtÄƒ PFv3/{domain}/{M##}@{semver}#{run_id_short} la fiecare run.








Blochezi execuÈ›ia pe entitlements. La Ã®ncÄƒrcarea aplicaÈ›iei, calculezi capabilitÄƒÈ›ile efective din PLAN âŠ• INDUSTRIE (âŠ• ADD-ON/LICENÈšÄ‚ dacÄƒ existÄƒ) È™i le aplici Ã®n UI È™i API Ã®nainte de orice run/export/test.

1) RegulÄƒ canonicÄƒ

capabilities â† plan/industrie

PLAN (Pilot/Pro/Enterprise) seteazÄƒ â€minimulâ€ de drepturi (feature flags).

INDUSTRIE (ex: FinTech/Eâ€‘commerce/Education Pack) poate adÄƒuga capabilitÄƒÈ›i sau impune preseturi (jargon/KPI/compliance/output) fÄƒrÄƒ sÄƒ le reducÄƒ pe cele ale planului.

(OpÈ›ional) ADDâ€‘ON/LICENÈšÄ‚ pot extinde capabilitÄƒÈ›ile (ex: Evaluator AI Advanced, Export Designer) sau porni modul offline/whiteâ€‘label.

CompoziÈ›ie: OR pe fiecare flag (ex.: canExportPDF = plan.canExportPDF OR pack.canExportPDF).

2) Matrice de flags (exemple)

canUseAllModules â€“ acces la M01â€“M50

canExportMD, canExportPDF, canExportJSON

canUseGptTestReal â€“ Test Engine pe GPT live

hasCloudHistory â€“ istoric cloud + reâ€‘runs

hasEvaluatorAI â€“ scor + feedback

hasAPI, hasWhiteLabel, canExportBundleZip, hasSeatsGT1

industryPack_{slug} â€“ marker boolean (ex: industryPack_fintech)

3) Model de date (minim)

Tabele (Supabase/Postgres):

plans(code, flags jsonb, module_allowlist text[])

subscriptions(org_id, plan_code, status, seats, â€¦)

entitlements(org_id, user_id?, flag text, value bool, source enum(plan|addon|pack|license), source_ref text, created_at)

industry_packs(slug, title, min_plan, price_eur, modules[], domain_config jsonb)

org_industry_packs(org_id, pack_slug, activated_at)

Vederi:

entitlements_effective(org_id, flag, enabled) = OR pe toate sursele.

org_plan_snapshot(org_id, plan_code, flags, module_allowlist, status).

4) Flux â€la Ã®ncÄƒrcareâ€ (client + server)

Autentificare â†’ primeÈ™ti org_id, user_id.

Fetch entitlements:

GET /api/entitlements/effective?org_id=â€¦ â†’ { flags: {canExportMD: true, â€¦}, plan: "pro", packs: ["fintech"] }

GET /api/packs/domain-config?org_id=â€¦ (dacÄƒ UI comutÄƒ domeniul).

Compose: capabilities = OR(plan.flags, packs.flags, user_addons.flags, licenses.flags).

Cache pe client (inâ€‘memory + storage scurt) È™i Ã®n server (5â€“30s) â€“ cu invalidare pe evenimente Stripe (webhook) sau schimbare de workspace.

UI gating:

ascunzi modulele din module_allowlist care nu sunt permise;

butoanele cu export/test/API devin disabled dacÄƒ flagul lipseÈ™te;

la click pe acÈ›iuni nepermise â†’ paywall/upsell (copie contextualÄƒ din pack/plan).

API middleware (serverâ€‘side, obligatoriu):

/api/run/{moduleId} â†’ assert(cap.canUseAllModules OR inAllowlist(moduleId)); assert(cap.canUseGptTestReal) dacÄƒ mode=real;

/api/export â†’ assert(cap.canExportPDF)/assert(cap.canExportJSON)/assert(cap.canExportBundleZip) dupÄƒ format;

/api/* (Enterprise) â†’ assert(cap.hasAPI);

403 ENTITLEMENT_REQUIRED dacÄƒ nu trece.

5) Industry preset (injectare 7D)

CÃ¢nd industryPack_* e activ È™i UI/domain = pack:

injectezi domain_config (jargon, KPIs, compliance, style_bias) Ã®n editor;

setezi defaults 7D (ex.: FinTech â†’ output_format=spec, urgency=sprint) È™i blochezi formatul dacÄƒ packâ€‘ul Ã®l impune (ex.: spec+json pentru audit).

6) Webhook Stripe â†’ entitlements (idempotent)

Evenimente: checkout.session.completed, customer.subscription.(created|updated|deleted)

Upsert subscription (org_id, plan_code, status, seats).

Apply PLAN: È™tergi entitlements de sursÄƒ plan È™i inserezi din plans.flags.

Apply ADDâ€‘ONS: inserezi entitlements source='addon' pe user/org.

Apply PACKS: inserezi Ã®n org_industry_packs + marker industryPack_{slug} Ã®n entitlements.

Regenerezi entitlements_effective (view sau materialized dacÄƒ la trafic mare).

Purge cache (client hint + server cache).

7) Algoritm (server, TypeScript)
type Flags = Record<string, boolean>

async function getCapabilities(orgId: string, userId?: string) {
  const plan = await db.org_plan_snapshot(orgId)           // flags plan + allowlist
  const ent = await db.query(`
    select flag, bool_or(value) as enabled
    from entitlements
    where org_id = $1
      and (user_id is null or user_id = $2)
    group by flag`, [orgId, userId])
  const caps: Flags = {...plan.flags}
  for (const r of ent) caps[r.flag] = Boolean(caps[r.flag] || r.enabled)
  return { plan: plan.plan_code, flags: caps, allowlist: plan.module_allowlist }
}


Middleware exemplu:

function assertExportCaps(caps: Flags, fmt: "md"|"pdf"|"json"|"bundle") {
  if (fmt==="pdf"  && !caps.canExportPDF)  throw err(403,"ENTITLEMENT_REQUIRED:PDF")
  if (fmt==="json" && !caps.canExportJSON) throw err(403,"ENTITLEMENT_REQUIRED:JSON")
  if (fmt==="bundle" && !caps.canExportBundleZip) throw err(403,"ENTITLEMENT_REQUIRED:BUNDLE")
}

8) UI gating (React hook)
export function useEntitlements(orgId: string){
  const {data} = useSWR(['/api/entitlements/effective', orgId], fetcher, {refreshInterval: 15000})
  const caps = data?.flags ?? {}
  return {
    caps,
    canRunReal: !!caps.canUseGptTestReal,
    canPDF: !!caps.canExportPDF,
    canJSON: !!caps.canExportJSON,
    canBundle: !!caps.canExportBundleZip,
    showModule: (m:string)=> caps.canUseAllModules || ['M01','M10','M18'].includes(m),
  }
}

9) Reguli de consistenÈ›Äƒ

Idempotent: reâ€‘aplicarea entitlements (plan/pack) suprascrie sursa sa, nu dubleazÄƒ rÃ¢nduri.

Prioritate: nimic nu â€dezactiveazÄƒâ€ un flag activat de plan; packs doar adaugÄƒ.

Failâ€‘safe: dacÄƒ entitlements lipsesc, UI cade Ã®n modul â€readâ€‘onlyâ€ (doar .txt) È™i API rÄƒspunde 403.

Audit: loghezi source, source_ref, created_at; pÄƒstrezi istoric pentru dispute.

Latency: È›inteÈ™te <100ms pentru getCapabilities (cache scurt + index pe (org_id, flag) È™i WHERE value = true).

10) Teste de acceptanÈ›Äƒ (must)

Creator: â€Export .pdfâ€ â†’ 403 + paywall Pro.

Pro: /api/run?mode=real â†’ 200; â€Export .bundle.zipâ€ â†’ 403 + upsell Enterprise.

Enterprise + FinTech Pack: editor seteazÄƒ output_format=spec by default; Export .pdf/.json/.bundle â†’ 201; manifest cu license_notice="Enterprise"; domain preset aplicat.

Webhook upgrade: Creatorâ†’Pro â†’ canExportPDF/JSON=true, hasCloudHistory=true; UI se deblocheazÄƒ fÄƒrÄƒ reload (SSE/WS sau reâ€‘fetch).

11) Edgeâ€‘cases

Trial Pro: flags Pro active pÃ¢nÄƒ la trial_end; autoâ€‘downgrade â†’ revoci entitlements plan='pro' È™i pÄƒstrezi packâ€‘urile (dar capabilitÄƒÈ›ile adiÈ›ionale rÄƒmÃ¢n blocate dacÄƒ min_plan=pro).

Seats: Enterprise cu hasSeatsGT1 â†’ validezi numÄƒrul de membri Ã®n org_members la invitaÈ›ie.

Selfâ€‘host/Whiteâ€‘label: hasWhiteLabel=true â†’ UI permite setarea brandului; API cheile sunt orgâ€‘scoped.

12) Mesajul de produs (clar)

â€Nu vinzi text. Vinzi drepturi. La Ã®ncÄƒrcare, sistemul Ã®È›i ataÈ™eazÄƒ capabilitÄƒÈ›ile din plan È™i industrie. Totul e UI+APIâ€‘gated. Restul e doar execuÈ›ie.â€

