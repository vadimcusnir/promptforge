#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Run English-only validation
pnpm english:scan

# Run lint-staged for code quality
npx lint-staged

# Secret pattern detection
echo "ğŸ” Checking for secrets..."

# Define secret patterns
SECRET_PATTERNS=(
  "sk-[a-zA-Z0-9]{48}"                    # OpenAI API keys
  "xoxb-[0-9]{11}-[0-9]{12}-[a-zA-Z0-9]{24}" # Slack bot tokens
  "xoxp-[0-9]{11}-[0-9]{12}-[a-zA-Z0-9]{24}" # Slack user tokens
  "AIza[0-9A-Za-z\\-_]{35}"               # Google API keys
  "AKIA[0-9A-Z]{16}"                      # AWS Access Key IDs
  "[0-9a-f]{32}"                          # MD5 hashes (potential secrets)
  "ghp_[A-Za-z0-9]{36}"                   # GitHub Personal Access Tokens
  "ghs_[A-Za-z0-9]{36}"                   # GitHub App tokens
  "gho_[A-Za-z0-9]{36}"                   # GitHub OAuth tokens
  "github_pat_[A-Za-z0-9]{22}_[A-Za-z0-9]{59}" # GitHub fine-grained tokens
  "-----BEGIN [A-Z ]+-----"               # Private keys
  "password[\"'\s]*[:=][\"'\s]*[^\s\"']{8,}" # Password patterns
  "secret[\"'\s]*[:=][\"'\s]*[^\s\"']{8,}"   # Secret patterns
  "token[\"'\s]*[:=][\"'\s]*[^\s\"']{16,}"    # Token patterns
)

# Check staged files for secret patterns
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -n "$STAGED_FILES" ]; then
  for pattern in "${SECRET_PATTERNS[@]}"; do
    if echo "$STAGED_FILES" | xargs grep -l -i -E "$pattern" 2>/dev/null; then
      echo "âŒ Potential secret detected with pattern: $pattern"
      echo "ğŸš« Commit rejected. Please remove secrets before committing."
      echo "ğŸ’¡ Consider using environment variables or encrypted secrets."
      exit 1
    fi
  done
fi

# Check for common secret file patterns
SECRET_FILES=(
  ".env"
  ".env.local"
  ".env.production"
  ".env.development"
  "*.pem"
  "*.key"
  "*.p12"
  "*.pfx"
  "id_rsa"
  "id_dsa"
  "id_ecdsa"
  "id_ed25519"
)

for file_pattern in "${SECRET_FILES[@]}"; do
  if echo "$STAGED_FILES" | grep -E "$file_pattern" 2>/dev/null; then
    echo "âŒ Potentially sensitive file detected: $file_pattern"
    echo "ğŸš« Commit rejected. Sensitive files should not be committed."
    echo "ğŸ’¡ Add to .gitignore or use encrypted storage."
    exit 1
  fi
done

echo "âœ… No secrets detected"
